-- âœ… Combo Event Script - Heo Edition

if _G.COMBO_EVENT then
    warn("â›” Script Ä‘Ã£ cháº¡y trÆ°á»›c Ä‘Ã³!")
    return
end
_G.COMBO_EVENT = true

-- âš™ï¸ Service & Data
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local Save = require(ReplicatedStorage.Library.Client.Save)

-- ğŸ—ºï¸ Map IDs
local FARM_PLACEID = 119454325063278
local FISH_PLACEID = 95635359880599

-- â±ï¸ Thá»i gian yÃªu cáº§u (30 phÃºt má»—i event)
local REQUIRED_SECONDS = 30 * 60

-- ğŸ“‚ Data runtime
local runtime = {
    farm = { total = 0, last = os.time(), done = false },
    fish = { total = 0, last = os.time(), done = false },
    lastDay = os.date("%d/%m/%Y"),
}

-- ğŸ› ï¸ Load/Save vÃ o local file
local HttpService = game:GetService("HttpService")
local function getFileName()
    return "comboEventLog.json"
end

local function loadData()
    if isfile(getFileName()) then
        local ok, data = pcall(function()
            return HttpService:JSONDecode(readfile(getFileName()))
        end)
        if ok and data then
            runtime = data
            warn("ğŸ“‚ ÄÃ£ load data:", data)
        end
    end
end

local function saveData()
    runtime.lastDay = os.date("%d/%m/%Y")
    writefile(getFileName(), HttpService:JSONEncode(runtime))
end

-- ğŸ”„ Reset theo ngÃ y
local function resetIfNewDay()
    local today = os.date("%d/%m/%Y")
    if runtime.lastDay ~= today then
        runtime = {
            farm = { total = 0, last = os.time(), done = false },
            fish = { total = 0, last = os.time(), done = false },
            lastDay = today,
        }
        saveData()
        warn("ğŸ†• Reset log cho ngÃ y má»›i:", today)
    end
end

-- ğŸ“Š Time tracking
local function updateProgress(which)
    local now = os.time()
    local data = runtime[which]
    data.total = data.total + (now - data.last)
    data.last = now
    if data.total >= REQUIRED_SECONDS then
        data.done = true
    end
    saveData()
end

-- â³ Tracker Farm
local function trackFarm()
    spawn(function()
        while not runtime.farm.done do
            updateProgress("farm")
            wait(10)
        end
        warn("ğŸŒ¾ Farm Ä‘á»§ 30 phÃºt!")
    end)
end

-- ğŸ£ Tracker Fishing
local function trackFishing()
    spawn(function()
        while not runtime.fish.done do
            updateProgress("fish")
            wait(10)
        end
        warn("ğŸ£ Fishing Ä‘á»§ 30 phÃºt!")
    end)
end

-- ğŸ§­ Smart Teleport
local function teleportToFarm()
    local tp = workspace.__THINGS.Instances.FarmingWorld.Teleports:GetChildren()[5]
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if tp and hrp then
        hrp.CFrame = tp.CFrame
        warn("ğŸš€ Teleport tá»›i Farm")
    else
        TeleportService:Teleport(FARM_PLACEID, player)
    end
end

local function teleportToFishing()
    local tp = workspace.__THINGS.Instances.FishingEvent.Teleports.Enter
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if tp and hrp then
        hrp.CFrame = tp.CFrame
        warn("ğŸš€ Teleport tá»›i Fishing")
    else
        TeleportService:Teleport(FISH_PLACEID, player)
    end
end

-- ğŸ•’ Time Trial Checker (khi Ä‘á»§ 10/10 thÃ¬ má»›i báº¯t Ä‘áº§u combo event)
local function getRunsUsed()
    local saveData = Save.Get()
    return saveData and saveData.TimeTrialStats and (saveData.TimeTrialStats.DailyRuns or 0) or 0
end

local function waitUntilMaxRuns()
    while true do
        local used = getRunsUsed()
        if used >= 10 then
            warn("âœ… ÄÃ£ Ä‘á»§ 10/10 Time Trial â†’ Báº¯t Ä‘áº§u combo event")
            break
        else
            local left = 10 - used
            warn("â³ Time Trial cÃ²n " .. left .. " lÆ°á»£t, Ä‘á»£i 5 phÃºt...")
            wait(300)
        end
    end
end

-- ğŸš¦ Main Controller
local function main()
    loadData()
    resetIfNewDay()
    waitUntilMaxRuns()

    local placeId = game.PlaceId

    -- Náº¿u Ä‘Ã£ Ä‘á»§ cáº£ farm & fishing
    if runtime.farm.done and runtime.fish.done then
        if placeId == FARM_PLACEID or placeId == FISH_PLACEID then
            player:Kick("ğŸ‰ ÄÃ£ xong cáº£ Farm & Fishing 30p, nghá»‰ thÃ´i!")
        else
            warn("âœ… ÄÃ£ xong cáº£ Farm & Fishing nhÆ°ng Ä‘ang á»Ÿ map khÃ¡c â†’ KhÃ´ng kick")
        end
        return
    end

    -- Náº¿u chÆ°a Ä‘á»§ â†’ xá»­ lÃ½ theo map hiá»‡n táº¡i
    if placeId == FARM_PLACEID then
        if not runtime.farm.done then
            trackFarm()
        elseif not runtime.fish.done then
            teleportToFishing()
        end

    elseif placeId == FISH_PLACEID then
        if not runtime.fish.done then
            trackFishing()
        elseif not runtime.farm.done then
            teleportToFarm()
        end

    else
        -- Map khÃ¡c â†’ Tele sang event cáº§n lÃ m
        if not runtime.farm.done then
            teleportToFarm()
        elseif not runtime.fish.done then
            teleportToFishing()
        end
    end
end

main()
