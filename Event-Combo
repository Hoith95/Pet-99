-- ✅ Combo Event Script - Heo Edition

if _G.COMBO_EVENT then
    warn("⛔ Script đã chạy trước đó!")
    return
end
_G.COMBO_EVENT = true

-- ⚙️ Service & Data
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local Save = require(ReplicatedStorage.Library.Client.Save)

-- 🗺️ Map IDs
local FARM_PLACEID = 119454325063278
local FISH_PLACEID = 95635359880599

-- ⏱️ Thời gian yêu cầu (30 phút mỗi event)
local REQUIRED_SECONDS = 30 * 60

-- 📂 Data runtime
local runtime = {
    farm = { total = 0, last = os.time(), done = false },
    fish = { total = 0, last = os.time(), done = false },
    lastDay = os.date("%d/%m/%Y"),
}

-- 🛠️ Load/Save vào local file
local HttpService = game:GetService("HttpService")
local function getFileName()
    return "comboEventLog.json"
end

local function loadData()
    if isfile(getFileName()) then
        local ok, data = pcall(function()
            return HttpService:JSONDecode(readfile(getFileName()))
        end)
        if ok and data then
            runtime = data
            warn("📂 Đã load data:", data)
        end
    end
end

local function saveData()
    runtime.lastDay = os.date("%d/%m/%Y")
    writefile(getFileName(), HttpService:JSONEncode(runtime))
end

-- 🔄 Reset theo ngày
local function resetIfNewDay()
    local today = os.date("%d/%m/%Y")
    if runtime.lastDay ~= today then
        runtime = {
            farm = { total = 0, last = os.time(), done = false },
            fish = { total = 0, last = os.time(), done = false },
            lastDay = today,
        }
        saveData()
        warn("🆕 Reset log cho ngày mới:", today)
    end
end

-- 📊 Time tracking
local function updateProgress(which)
    local now = os.time()
    local data = runtime[which]
    data.total = data.total + (now - data.last)
    data.last = now
    if data.total >= REQUIRED_SECONDS then
        data.done = true
    end
    saveData()
end

-- ⏳ Tracker Farm
local function trackFarm()
    spawn(function()
        while not runtime.farm.done do
            updateProgress("farm")
            wait(10)
        end
        warn("🌾 Farm đủ 30 phút!")
    end)
end

-- 🎣 Tracker Fishing
local function trackFishing()
    spawn(function()
        while not runtime.fish.done do
            updateProgress("fish")
            wait(10)
        end
        warn("🎣 Fishing đủ 30 phút!")
    end)
end

-- 🧭 Smart Teleport
local function teleportToFarm()
    local tp = workspace.__THINGS.Instances.FarmingWorld.Teleports:GetChildren()[5]
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if tp and hrp then
        hrp.CFrame = tp.CFrame
        warn("🚀 Teleport tới Farm")
    else
        TeleportService:Teleport(FARM_PLACEID, player)
    end
end

local function teleportToFishing()
    local tp = workspace.__THINGS.Instances.FishingEvent.Teleports.Enter
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if tp and hrp then
        hrp.CFrame = tp.CFrame
        warn("🚀 Teleport tới Fishing")
    else
        TeleportService:Teleport(FISH_PLACEID, player)
    end
end

-- 🕒 Time Trial Checker (khi đủ 10/10 thì mới bắt đầu combo event)
local function getRunsUsed()
    local saveData = Save.Get()
    return saveData and saveData.TimeTrialStats and (saveData.TimeTrialStats.DailyRuns or 0) or 0
end

local function waitUntilMaxRuns()
    while true do
        local used = getRunsUsed()
        if used >= 10 then
            warn("✅ Đã đủ 10/10 Time Trial → Bắt đầu combo event")
            break
        else
            local left = 10 - used
            warn("⏳ Time Trial còn " .. left .. " lượt, đợi 5 phút...")
            wait(300)
        end
    end
end

-- 🚦 Main Controller
local function main()
    loadData()
    resetIfNewDay()
    waitUntilMaxRuns()

    local placeId = game.PlaceId

    -- Nếu đã đủ cả farm & fishing
    if runtime.farm.done and runtime.fish.done then
        if placeId == FARM_PLACEID or placeId == FISH_PLACEID then
            player:Kick("🎉 Đã xong cả Farm & Fishing 30p, nghỉ thôi!")
        else
            warn("✅ Đã xong cả Farm & Fishing nhưng đang ở map khác → Không kick")
        end
        return
    end

    -- Nếu chưa đủ → xử lý theo map hiện tại
    if placeId == FARM_PLACEID then
        if not runtime.farm.done then
            trackFarm()
        elseif not runtime.fish.done then
            teleportToFishing()
        end

    elseif placeId == FISH_PLACEID then
        if not runtime.fish.done then
            trackFishing()
        elseif not runtime.farm.done then
            teleportToFarm()
        end

    else
        -- Map khác → Tele sang event cần làm
        if not runtime.farm.done then
            teleportToFarm()
        elseif not runtime.fish.done then
            teleportToFishing()
        end
    end
end

main()
