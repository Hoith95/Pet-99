local PLACE_ID = 95635359880599
local MAX_RETRIES = 15
local WAIT_BEFORE_RECHECK = 15

local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- âœ… Kiá»ƒm tra sá»‘ lÆ°á»£ng ngÆ°á»i chÆ¡i hiá»‡n táº¡i (cÃ³ fallback náº¿u GetPlayers() lá»—i)
local function isPlayerCountValid()
    local count
    local success, result = pcall(function()
        return #Players:GetPlayers()
    end)

    if success and result then
        count = result
    else
        -- Fallback: Ä‘áº¿m sá»‘ lÆ°á»£ng Player tá»« Players:GetChildren()
        local tempCount = 0
        for _, player in ipairs(Players:GetChildren()) do
            if player:IsA("Player") then
                tempCount += 1
            end
        end
        count = tempCount
        warn("âš ï¸ Fallback GetPlayers(): sá»‘ lÆ°á»£ng Ä‘áº¿m Ä‘Æ°á»£c:", count)
    end

    print("ðŸ‘¥ Sá»‘ lÆ°á»£ng ngÆ°á»i chÆ¡i hiá»‡n táº¡i:", count)
    return count >= 2 and count <= 5
end

-- âœ… Hop server Ä‘áº¿n server Ã­t ngÆ°á»i (tá»« server thá»© 3 trá»Ÿ Ä‘i)
local function teleportToLeastPopulatedServer(placeId, runScriptOnJoin, retryLimit)
    retryLimit = retryLimit or MAX_RETRIES
    local attempts = 0

    while attempts < retryLimit do
        attempts += 1
        local success, result = pcall(function()
            return HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. placeId .. '/servers/Public?sortOrder=Asc&limit=50&excludeFullServers=true')).data
        end)

        if success and result and #result > 2 then
            local validServers = {}
            for _, server in ipairs(result) do
                if server.playing > 0 and server.playing < server.maxPlayers then
                    table.insert(validServers, server)
                end
            end

            if #validServers > 2 then
                table.sort(validServers, function(a, b)
                    return a.playing < b.playing
                end)

                local selectedServer = validServers[3]
                local teleportData = runScriptOnJoin and "RUNSCRIPT" or "NOSCRIPT"

                local teleportSuccess, teleportErr = pcall(function()
                    TeleportService:TeleportToPlaceInstance(placeId, selectedServer.id, LocalPlayer, { customData = teleportData })
                end)

                if teleportSuccess then
                    print("âœ… Teleport thÃ nh cÃ´ng Ä‘áº¿n server:", selectedServer.id)
                    return true
                else
                    warn("âš ï¸ Teleport tháº¥t báº¡i (Láº§n " .. attempts .. "): " .. tostring(teleportErr))
                end
            else
                warn("KhÃ´ng Ä‘á»§ server há»£p lá»‡ (cáº§n tá»‘i thiá»ƒu 3 server).")
            end
        else
            warn("âŒ KhÃ´ng thá»ƒ láº¥y danh sÃ¡ch server (láº§n " .. attempts .. ")")
        end

        task.wait(5)
    end

    warn("â›” Teleport tháº¥t báº¡i sau " .. retryLimit .. " láº§n thá»­!")
    return false
end

-- âœ… Kiá»ƒm tra náº¿u player vá»«a Ä‘Æ°á»£c teleport tá»« nÆ¡i khÃ¡c
local tpInfo = TeleportService:GetLocalPlayerTeleportData()
local resumedFromTeleport = tpInfo and tpInfo.customData

-- ðŸŸ¡ Náº¿u vá»«a tá»« láº§n teleport Ä‘áº§u tiÃªn sang:
if resumedFromTeleport == "NOSCRIPT" then
    print("ðŸ” Vá»«a teleport láº§n 1 sang, chá» 15s rá»“i kiá»ƒm tra sá»‘ lÆ°á»£ng ngÆ°á»i chÆ¡i...")
    task.wait(WAIT_BEFORE_RECHECK)
    if isPlayerCountValid() then
        print("âœ… Sá»‘ lÆ°á»£ng ngÆ°á»i chÆ¡i phÃ¹ há»£p sau láº§n hop Ä‘áº§u. Dá»«ng script.")
        return
    else
        print("ðŸ” Tiáº¿p tá»¥c hop láº§n 2, láº§n nÃ y sáº½ cháº¡y script sau khi vÃ o.")
        teleportToLeastPopulatedServer(PLACE_ID, true)
        return
    end
end

-- ðŸŸ¢ Náº¿u vá»«a tá»« láº§n teleport thá»© 2 sang:
if resumedFromTeleport == "RUNSCRIPT" then
    print("âœ… ÄÃ£ hop láº§n 2. Tiáº¿n hÃ nh load script.")
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Hoith95/Pet-99/main/WaitForGameLoad"))()
    return
end

-- ðŸ”µ Náº¿u lÃ  láº§n cháº¡y Ä‘áº§u tiÃªn
if isPlayerCountValid() then
    print("âœ… Server hiá»‡n táº¡i Ä‘Ã£ phÃ¹ há»£p, khÃ´ng cáº§n hop.")
    return
else
    print("âŒ Server khÃ´ng phÃ¹ há»£p. Báº¯t Ä‘áº§u hop láº§n Ä‘áº§u...")
    teleportToLeastPopulatedServer(PLACE_ID, false)
end
