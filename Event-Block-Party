if _G.VAR_BLOCK_PARTY then
	warn("â›” Script Ä‘Ã£ Ä‘Æ°á»£c cháº¡y trÆ°á»›c Ä‘Ã³!")
	return
end

_G.VAR_BLOCK_PARTY = true
local isRunning = false

-- âš™ï¸ Dá»‹ch vá»¥ & Folder
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local player = game.Players.LocalPlayer
local TilesFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("Tiles")
local NLibrary = ReplicatedStorage.Library
local EggCmds = require(NLibrary.Client.EggCmds)
local Save = require(ReplicatedStorage.Library.Client.Save)
local Network = ReplicatedStorage:WaitForChild("Network")
local CustomEggsFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("CustomEggs")

-- ğŸ”¢ Äáº¿m tá»•ng sá»‘ tile
local function getTotalTileCount()
	return #TilesFolder:GetChildren()
end

-- ğŸ§  Dá»«ng toÃ n bá»™ khi bá»‹ stop
local function waitUntilAllowed()
	while _G.VAR_STOP_BLOCK_PARTY and not _G.VAR_START_BLOCK_PARTY do
		warn("â¸ Script Ä‘ang bá»‹ táº¡m dá»«ng bá»Ÿi _G.VAR_STOP_BLOCK_PARTY")
		task.wait(1)
	end
	if not _G.VAR_START_BLOCK_PARTY then
		isRunning = false
	end
end

function teleportTo(cf)
	local character = player.Character or player.CharacterAdded:Wait()
	local hrp = character:FindFirstChild("HumanoidRootPart")
	if hrp then
		hrp.CFrame = cf
	end
end

local function teleportToBlockParty()
	local Enter = workspace.__THINGS.Instances.BlockParty.Teleports.Enter

	-- ğŸ§­ Teleport vÃ o Block Party & Ä‘áº¿n vá»‹ trÃ­ cá»¥ thá»ƒ
	teleportTo(Enter.CFrame + Vector3.new(0, 5, 0))
	task.wait(15)
	teleportTo(CFrame.new(16460, 2275, -21473))
end
---------------- ğŸ§© LUá»’NG 1: Mua tiles quanh plot ----------------
local function startAutoPurchase()
	local radiusMax = 6
	local delayPerTile = 0.05
	local delayPerCycle = 0.05

	local PlotsInvoke = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Plots_Invoke")

	-- ğŸ’  Táº¡o danh sÃ¡ch offsets quanh plot
	local offsets = {}
	for dx = -radiusMax, radiusMax do
		for dy = -radiusMax, radiusMax do
			if not (dx == 0 and dy == 0) then
				table.insert(offsets, {dx, dy})
			end
		end
	end

	-- ğŸ“Œ HÃ m láº¥y plotIndex Ä‘á»™ng
	local function getCurrentPlotIndex()
		local index = 1
		pcall(function()
			local plots = Workspace.__THINGS:FindFirstChild("Plots")
			if plots then
				for _, v in ipairs(plots:GetChildren()) do
					if tonumber(v.Name) then
						index = tonumber(v.Name)
						break
					end
				end
			end
		end)
		return index
	end

	while true do
		waitUntilAllowed()
		local saveData = Save.Get()
		local tileRebirth = saveData.TileRebirth or 0
		local totalTiles = getTotalTileCount()
		local hugeChance = _G.CURRENT_HUGE_CHANCE or 0

		-- ğŸ›‘ Dá»«ng háº³n náº¿u Ä‘á»§ 3 Ä‘iá»u kiá»‡n
		if tileRebirth >= 15 and totalTiles >= 169 and hugeChance >= 25 then
			warn("âœ… ÄÃ£ Ä‘áº¡t Ä‘á»§ Ä‘iá»u kiá»‡n (Tiles â‰¥169, Rebirth â‰¥15, HugeChance â‰¥25x) â†’ Dá»«ng Auto Purchase.")
			break
		end

		if totalTiles >= 169 then
			warn("â³ Tiles â‰¥169 â†’ chá» 30s trÆ°á»›c khi kiá»ƒm tra láº¡i.")
			task.wait(30)
		else
			for _, offset in ipairs(offsets) do
				local plotIndex = getCurrentPlotIndex()
				local args = {plotIndex, "PurchaseTile", offset[1], offset[2]}
				pcall(function()
					PlotsInvoke:InvokeServer(unpack(args))
				end)
				task.wait(delayPerTile)
			end
			task.wait(delayPerCycle)
		end
	end
end

---------------- ğŸ§© LUá»’NG 2: Claim + Open + Unlock + Plant + Diamond ----------------
local function startTileHandler()
	local TilesInvoke = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Tiles_Invoke")
	local TilesFire = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Tiles_Fire")
	local delayPerTile = 0.05
	local delayPerCycle = 0.5

	while true do
		waitUntilAllowed()
		for _, tile in ipairs(TilesFolder:GetChildren()) do
			local tileId = tile.Name

			-- âœ… Claim + Open (Tiles_Invoke)
			pcall(function() TilesInvoke:InvokeServer(tileId, "Claim") end)
			pcall(function() TilesInvoke:InvokeServer(tileId, "Open") end)

			-- âœ… Claim + Unlock (Tiles_Fire)
			pcall(function() TilesFire:FireServer(tileId, "Claimed") end)
			pcall(function() TilesFire:FireServer(tileId, "Unlock") end)

			-- âœ… Claim Plant[i] (1 -> 6)
			if tile:IsA("Model") or tile:IsA("Folder") then
				if tile:FindFirstChild("Plant1") then
					for i = 1, 6 do
						pcall(function()
							TilesInvoke:InvokeServer(tileId, "Claim", i)
						end)
						task.wait(0.05)
					end
				end

				-- âœ… Claim Diamond
				if tile:FindFirstChild("Diamond") then
					pcall(function()
						TilesInvoke:InvokeServer(tileId, "Tile_ClaimDiamonds")
					end)
					task.wait(0.1)
				end
			end

			task.wait(delayPerTile)
		end

		task.wait(delayPerCycle)
	end
end

---------------- ğŸ§© LUá»’NG 3: Hatch HUGE CHANCE ----------------
_G.CURRENT_HUGE_CHANCE = 0
local tileThreshold = 169

local function extractHugeLuckValue(text)
    local value = text:match("(%d+)x%s+Huge%s+Luck!?")
    return tonumber(value or "0")
end

local function findEggNearTile(tile)
    local closestEgg, minDist = nil, math.huge
    for _, eggModel in pairs(CustomEggsFolder:GetChildren()) do
        local egg = eggModel:FindFirstChild("Egg")
        if egg and egg:FindFirstChild("slashes") and eggModel:IsA("Model") then
            local part = eggModel:FindFirstChild("Part")
            if part and tile.PrimaryPart then
                local dist = (part.Position - tile.PrimaryPart.Position).Magnitude
                if dist < minDist then
                    closestEgg, minDist = eggModel, dist
                end
            end
        end
    end
    return closestEgg
end

local function findBestHugeTile()
    local bestTile, bestValue = nil, -1
    for _, tile in pairs(TilesFolder:GetChildren()) do
        local label = tile:FindFirstChild("Sign")
            and tile.Sign:FindFirstChild("SurfaceGui")
            and tile.Sign.SurfaceGui:FindFirstChild("Frame")
            and tile.Sign.SurfaceGui.Frame:FindFirstChild("Frame")
            and tile.Sign.SurfaceGui.Frame.Frame:FindFirstChild("TextLabel")
        if label and label:IsA("TextLabel") then
            local value = extractHugeLuckValue(label.Text)
            if value > bestValue then
                local egg = findEggNearTile(tile)
                if egg then
                    bestTile, bestValue = tile, value
                end
            end
        end
    end
    _G.CURRENT_HUGE_CHANCE = bestValue
    return bestTile, bestValue
end

local function teleportToTile(tile)
    if tile and tile:IsA("Model") and tile.PrimaryPart then
        teleportTo(tile.PrimaryPart.CFrame + Vector3.new(0, 5, 0))
        print("ğŸ“ Teleport Ä‘áº¿n tile:", tile.Name)
    end
end

local function handleRejoin()
    local Leave = workspace.__THINGS.Instances.LuckyBlocks.Teleports.Leave
    teleportTo(Leave.CFrame + Vector3.new(0, 5, 0))
    task.wait(15)
    teleportToBlockParty()
    task.wait(9)
end

local function isNearEgg(egg)
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not (hrp and egg) then return false end
    local part = egg:FindFirstChild("Part")
    if not part then return false end
    return (hrp.Position - part.Position).Magnitude < 15
end

local function startAutoHatchHuge()
    task.spawn(function()
        -- ğŸ§· Luá»“ng nÃ y chá»‰ báº¯t Ä‘áº§u khi Ä‘á»§ tiles
        while getTotalTileCount() < tileThreshold do
            warn("â³ Tiles chÆ°a Ä‘áº¡t Ä‘á»§ " .. tileThreshold .. " â†’ chÆ°a khá»Ÿi Ä‘á»™ng Luá»“ng 3")
            task.wait(5)
        end

        task.wait(2)

        -- Táº¯t animation má»Ÿ trá»©ng
        local successEggs, Eggs = pcall(function()
            return player:WaitForChild("PlayerScripts"):WaitForChild("Scripts"):WaitForChild("Game"):WaitForChild("Egg Opening Frontend")
        end)
        if successEggs and Eggs then
            pcall(function()
                getsenv(Eggs).PlayEggAnimation = function() return end
            end)
        end

        local bestTile, bestEgg = nil, nil

        local function safeHatchLoop()
            while true do
                waitUntilAllowed()

                if not bestEgg or not bestEgg:IsDescendantOf(workspace) then
                    warn("âŒ Egg hiá»‡n táº¡i Ä‘Ã£ máº¥t, Ä‘ang tÃ¬m láº¡i...")
                    task.wait(2)
                    bestEgg = findEggNearTile(bestTile)
                    if bestEgg then
                        print("âœ… ÄÃ£ tÃ¬m láº¡i Ä‘Æ°á»£c egg:", bestEgg.Name)
                        teleportTo(bestEgg.Part.CFrame + Vector3.new(0, 5, 0))
                        task.wait(1)
                    else
                        print("âŒ KhÃ´ng tÃ¬m tháº¥y egg â†’ reset map")
                        handleRejoin()
                        break
                    end
                end

                if not isNearEgg(bestEgg) then
                    print("ğŸš¶â€â™‚ï¸ KhÃ´ng á»Ÿ gáº§n egg, teleport láº¡i...")
                    teleportTo(bestEgg.Part.CFrame + Vector3.new(0, 5, 0))
                    task.wait(1)
                end

                local MaxEggHatch = EggCmds.GetMaxHatch()
                local args = {bestEgg.Name, MaxEggHatch}
                local success, err = pcall(function()
                    Network.CustomEggs_Hatch:InvokeServer(unpack(args))
                end)
                if not success then
                    warn("âŒ Hatch lá»—i:", err)
                end

                task.wait(0.5)
            end
        end

        -- ğŸ” VÃ²ng kiá»ƒm tra tile tá»‘t hÆ¡n má»—i 10 phÃºt
        while true do
            waitUntilAllowed()
            local initialTile, initialChance = findBestHugeTile()
            if initialTile and initialChance > 0 then
                bestTile = initialTile
                bestEgg = findEggNearTile(initialTile)
                teleportToTile(bestTile)
                task.wait(1)
                print("ğŸ¥š Báº¯t Ä‘áº§u ná»Ÿ á»Ÿ tile:", bestTile.Name, "|", tostring(_G.CURRENT_HUGE_CHANCE) .. "x")

                task.spawn(function()
                    while true do
                        task.wait(600)
                        waitUntilAllowed()
                        local newTile, newChance = findBestHugeTile()
                        if newTile and newTile.PrimaryPart and newChance > (_G.CURRENT_HUGE_CHANCE or 0) then
                            _G.CURRENT_HUGE_CHANCE = newChance
                            print("ğŸ” Tile má»›i tá»‘t hÆ¡n:", newTile.Name, "|", tostring(newChance) .. "x")

                            bestTile = newTile
                            bestEgg = findEggNearTile(newTile)
                            teleportToTile(newTile)
                            task.wait(1)

                            if bestEgg then
                                print("âœ… Egg má»›i:", bestEgg.Name)
                            else
                                warn("âŒ KhÃ´ng tÃ¬m tháº¥y egg má»›i!")
                            end
                        else
                            print("â¸ Váº«n giá»¯ tile:", bestTile.Name, "|", tostring(_G.CURRENT_HUGE_CHANCE) .. "x")
                        end
                    end
                end)

                safeHatchLoop()
            else
                print("âŒ KhÃ´ng cÃ³ tile nÃ o cÃ³ Huge Chance + egg.slashes â†’ thá»­ teleport thá»§ cÃ´ng trÆ°á»›c khi reset")
                teleportTo(CFrame.new(16460, 2275, -21473))
                task.wait(3)

                local retryTile, retryChance = findBestHugeTile()
                if retryTile and retryChance > 0 then
                    _G.CURRENT_HUGE_CHANCE = retryChance
                    bestTile = retryTile
                    bestEgg = findEggNearTile(retryTile)
                    teleportToTile(retryTile)
                    task.wait(1)
                    safeHatchLoop()
                else
                    print("âŒ Váº«n khÃ´ng tÃ¬m tháº¥y tile â†’ reset map")
                    handleRejoin()
                end
            end
            task.wait(5)
        end
    end)
end

---------------- ğŸ§© LUá»’NG 4: Auto SummerGiftBag2025 ----------------
local function startAutoGiftBag()
    local function getCurrencyAmount(itemId)
        local Inventory = Save.Get().Inventory
        for _, v in pairs(Inventory.Misc) do 
            if v.id == itemId then
                return tonumber(v._am) or 0
            end
        end
        return 0
    end

    while true do
        waitUntilAllowed()

        if getTotalTileCount() >= 50 then
            local flowerCount = getCurrencyAmount("Tropical Flower")
            if flowerCount >= 10 then
                local args = {10}
                pcall(function()
                    Network.SummerGiftBag2025Machine_Activate:InvokeServer(unpack(args))
                    print("ğŸ ÄÃ£ Ä‘á»•i 10 Tropical Flower thÃ nh Gift Bag")
                end)
            end
        end

        task.wait(30)
    end
end

---------------- ğŸ§© LUá»’NG 5: Auto Rebirth (cáº£i tiáº¿n) ----------------
local function startAutoRebirth()
	local PlotsInvoke = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Plots_Invoke")
	local threshold = 169

	while true do
		waitUntilAllowed()
		local saveData = Save.Get()
		local tileRebirth = saveData.TileRebirth or 0
		local hugeChance = _G.CURRENT_HUGE_CHANCE or 0

		if tileRebirth >= 15 and hugeChance >= 25 then
			warn("ğŸ›‘ ÄÃ£ Ä‘áº¡t TileRebirth = 15 vÃ  HugeChance >= 25x â†’ Dá»«ng Auto Rebirth.")
			break
		end

		if getTotalTileCount() >= threshold then
			local args = {1, "Rebirth"}
			pcall(function()
				PlotsInvoke:InvokeServer(unpack(args))
				print("ğŸ” ÄÃ£ gá»­i yÃªu cáº§u Rebirth | TileRebirth hiá»‡n táº¡i:", tileRebirth)
			end)
		end

		task.wait(2)
	end
end
        	
---------------- ğŸš€ KÃ­ch hoáº¡t táº¥t cáº£ luá»“ng song song ----------------
local function startAllBlockPartyTasks()
	if isRunning then return end
	isRunning = true
	print("ğŸš€ ÄÃ£ kÃ­ch hoáº¡t startAllBlockPartyTasks")

	-- ğŸ§© LUá»’NG 1: Auto Purchase
	task.spawn(function()
		local Save = require(ReplicatedStorage.Library.Client.Save)
		while true do
			local saveData = Save.Get()
			local tileRebirth = saveData.TileRebirth or 0
			local totalTiles = getTotalTileCount()
			local hugeChance = _G.CURRENT_HUGE_CHANCE or 0

			if tileRebirth >= 15 and totalTiles >= 169 and hugeChance >= 25 then
				warn("ğŸ›‘ ÄÃ£ Ä‘áº¡t Ä‘á»§ Ä‘iá»u kiá»‡n (15 Rebirth, 169 Tiles, 25x Huge) â†’ KHÃ”NG khá»Ÿi Ä‘á»™ng luá»“ng mua tiles.")
				break
			else
				print("âœ… ÄÃ£ khá»Ÿi Ä‘á»™ng LUá»’NG 1: Auto Purchase")
				startAutoPurchase()
				break
			end
			task.wait(5)
		end
	end)

	-- ğŸ§© LUá»’NG 2: Tile Handler
	task.spawn(function()
		print("âœ… ÄÃ£ khá»Ÿi Ä‘á»™ng LUá»’NG 2: Tile Handler (Claim/Open/Unlock/Plant/Diamond)")
		startTileHandler()
	end)

	-- ğŸ§© LUá»’Ì€NG 3: Hatch HUGE CHANCE
	task.spawn(function()
	    while true do
	        while getTotalTileCount() < tileThreshold do
	            warn("â³ Tiles chÆ°a Ä‘áº¡t Ä‘á»§ " .. tileThreshold .. " â†’ chÆ°a khá»Ÿi Luá»“ngÂ 3")
	            task.wait(5)
	        end

	        print("âœ… ÄÃ£ Ä‘á»§ " .. tileThreshold .. " tiles â†’ Khá»Ÿi LUá»’Ì€NGÂ 3: Hatch HUGE CHANCE")
	        startAutoHatchHuge()

	        repeat
	            task.wait(5)
	        until getTotalTileCount() < tileThreshold

	        print("ğŸ”„ Tiles Ä‘Ã£ xuá»‘ng dÆ°á»›i " .. tileThreshold .. ", chuáº©n bá»‹ cháº¡y láº¡i Luá»“ngÂ 3")
	    end
	end)

	-- ğŸ§© LUá»’NG 4: Auto Gift Bag
	task.spawn(function()
		while true do
			while getTotalTileCount() < 50 do
				task.wait(2)
			end
			print("âœ… ÄÃ£ khá»Ÿi Ä‘á»™ng LUá»’NG 4: Auto SummerGiftBag2025")
			startAutoGiftBag()
		end
	end)

	-- ğŸ§© LUá»’NG 5: Auto Rebirth
	task.spawn(function()
		local Save = require(ReplicatedStorage.Library.Client.Save)
		while true do
			local saveData = Save.Get()
			local tileRebirth = saveData.TileRebirth or 0
			local hugeChance = _G.CURRENT_HUGE_CHANCE or 0

			if tileRebirth >= 15 and hugeChance >= 25 then
				warn("ğŸ›‘ ÄÃ£ Ä‘áº¡t TileRebirth = 15 vÃ  HugeChance >= 25x â†’ KHÃ”NG khá»Ÿi Ä‘á»™ng luá»“ng Rebirth.")
				break
			else
				print("âœ… ÄÃ£ khá»Ÿi Ä‘á»™ng LUá»’NG 5: Auto Rebirth")
				startAutoRebirth()
				break
			end
			task.wait(5)
		end
	end)
end

task.spawn(function()
	while true do
		if _G.VAR_STOP_BLOCK_PARTY and _G.VAR_BLOCK_PARTY then
			isRunning = false
			
		end

		if _G.VAR_START_BLOCK_PARTY and not isRunning then
			startAllBlockPartyTasks()
			teleportToBlockParty()
		end

		task.wait(2)
	end
end)
