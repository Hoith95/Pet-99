local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

---------------- üß© LU·ªíNG 1: Mua tiles quanh Plot ----------------
local function startAutoPurchase()
	local plotIndex = 1
	local radiusMax = 6
	local delayPerTile = 0.05
	local delayPerCycle = 0.05

	local PlotsInvoke = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Plots_Invoke")

	local offsets = {}
	for dx = -radiusMax, radiusMax do
		for dy = -radiusMax, radiusMax do
			if not (dx == 0 and dy == 0) then
				table.insert(offsets, {dx, dy})
			end
		end
	end

	local function purchaseTile(dx, dy)
		local args = {plotIndex, "PurchaseTile", dx, dy}
		pcall(function()
			PlotsInvoke:InvokeServer(unpack(args))
		end)
	end

	while true do
		for _, offset in ipairs(offsets) do
			purchaseTile(offset[1], offset[2])
			task.wait(delayPerTile)
		end
		task.wait(delayPerCycle)
	end
end

---------------- üß© LU·ªíNG 2: Claim + Open b·∫±ng Tiles_Invoke ----------------
local function startClaimAndOpen()
	local TilesInvoke = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Tiles_Invoke")
	local tilesFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("Tiles")
	local delayPerTile = 0.05
	local delayPerCycle = 0.05

	while true do
		for _, tile in ipairs(tilesFolder:GetChildren()) do
			local tileId = tile.Name
			pcall(function() TilesInvoke:InvokeServer(tileId, "Claim") end)
			pcall(function() TilesInvoke:InvokeServer(tileId, "Open") end)
			task.wait(delayPerTile)
		end
		task.wait(delayPerCycle)
	end
end

---------------- üß© LU·ªíNG 3: Claim + Unlock b·∫±ng Tiles_Fire ----------------
local function startClaimAndUnlock()
	local TilesFire = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Tiles_Fire")
	local tilesFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("Tiles")
	local delayPerTile = 0.05
	local delayPerCycle = 0.05

	while true do
		for _, tile in ipairs(tilesFolder:GetChildren()) do
			local tileId = tile.Name
			pcall(function() TilesFire:FireServer(tileId, "Claimed") end)
			pcall(function() TilesFire:FireServer(tileId, "Unlock") end)
			task.wait(delayPerTile)
		end
		task.wait(delayPerCycle)
	end
end

---------------- üß© LU·ªíNG 4: Auto Claim Plant + Diamond ----------------
local function startAutoPlantDiamond()
	local TilesInvoke = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Tiles_Invoke")
	local tilesFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("Tiles")

	while true do
		for _, tile in ipairs(tilesFolder:GetChildren()) do
			if tile:IsA("Model") or tile:IsA("Folder") then
				local tileId = tile.Name
				if tile:FindFirstChild("Plant1") then
					for i = 0, 6 do
						pcall(function()
							TilesInvoke:InvokeServer(tileId, "Claim", i)
						end)
						task.wait(0.1)
					end
				end
				if tile:FindFirstChild("Diamond") then
					pcall(function()
						TilesInvoke:InvokeServer(tileId, "Tile_ClaimDiamonds")
					end)
					task.wait(0.1)
				end
			end
		end
		task.wait(30)
	end
end

---------------- üß© LU·ªíNG 5: T·ª± ƒë·ªông m·ªü egg HUGE CHANCE cao nh·∫•t ----------------
local function startAutoHatchHuge()
	local player = Players.LocalPlayer
	local character = player.Character or player.CharacterAdded:Wait()
	local hrp = character:WaitForChild("HumanoidRootPart")
	local Network = ReplicatedStorage:WaitForChild("Network")
	local customEggsFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("CustomEggs")
	local PlotsFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("Plots")

	local plotIndex = 1
	local tileThreshold = 100

	-- T·∫Øt animation m·ªü tr·ª©ng
	local Eggs = player:WaitForChild("PlayerScripts"):WaitForChild("Scripts"):WaitForChild("Game"):WaitForChild("Egg Opening Frontend")
	getsenv(Eggs).PlayEggAnimation = function() return end

	local function isEncodedName(name)
		return #name >= 32 and name:match("^[a-f0-9]+$") ~= nil
	end

	local function extractChanceValue(text)
		local num = text:match("(%d+)x%s+HUGE%s+CHANCE!?")
		return tonumber(num or "0")
	end

	local function teleportToEgg(egg)
		local part = egg:FindFirstChildWhichIsA("BasePart", true)
		if part then
			hrp.CFrame = part.CFrame + Vector3.new(0, 5, 0)
			return true
		end
		return false
	end

	local function findBestHugeChanceEgg(eggList)
		local bestEgg = nil
		local bestValue = -1
		for _, egg in ipairs(eggList) do
			local label = egg:FindFirstChild("Egg")
				and egg.Egg:FindFirstChild("EggInfo")
				and egg.Egg.EggInfo:FindFirstChild("Frame")
				and egg.Egg.EggInfo.Frame:FindFirstChild("Title")
			if label and label:IsA("TextLabel") then
				local value = extractChanceValue(label.ContentText)
				if value > bestValue then
					bestEgg = egg
					bestValue = value
				end
			end
		end
		return bestEgg, bestValue
	end

	local knownEggs = {}
	local function updateKnownEggs()
		for _, egg in ipairs(customEggsFolder:GetChildren()) do
			if isEncodedName(egg.Name) then
				local exists = false
				for _, e in ipairs(knownEggs) do
					if e == egg then
						exists = true
						break
					end
				end
				if not exists then
					table.insert(knownEggs, egg)
				end
			end
		end
	end

	-- ‚è≥ Lu·ªìng ch√≠nh ki·ªÉm tra tile v√† qu·∫£n l√Ω m·ªü egg
	while true do
		local function getTileCount()
			local plot = PlotsFolder:FindFirstChild(tostring(plotIndex))
			if plot and plot:FindFirstChild("Tiles") then
				return #plot.Tiles:GetChildren()
			end
			return 0
		end

		if getTileCount() >= tileThreshold then
			updateKnownEggs()
			for _, egg in ipairs(knownEggs) do
				teleportToEgg(egg)
				task.wait(0.2)
			end

			local currentEgg, currentValue = findBestHugeChanceEgg(knownEggs)
			if currentEgg then
				teleportToEgg(currentEgg)
				task.wait(0.5)

				-- Lu·ªìng ph·ª• c·∫≠p nh·∫≠t egg t·ªët nh·∫•t m·ªói 5 ph√∫t
				task.spawn(function()
					while true do
						task.wait(300)
						updateKnownEggs()
						for _, egg in ipairs(knownEggs) do
							teleportToEgg(egg)
							task.wait(0.3)
						end
						local bestEgg, bestValue = findBestHugeChanceEgg(knownEggs)
						if bestEgg and bestValue > currentValue then
							currentEgg = bestEgg
							currentValue = bestValue
							teleportToEgg(currentEgg)
							task.wait(0.5)
						end
					end
				end)

				-- üîÅ V√≤ng m·ªü egg li√™n t·ª•c n·∫øu ƒë·ªß tile
				while getTileCount() >= tileThreshold do
					local args = {currentEgg.Name, 89}
					pcall(function()
						Network.CustomEggs_Hatch:InvokeServer(unpack(args))
					end)
					task.wait(0) -- Kh√¥ng delay ƒë·ªÉ t·ªëi ∆∞u t·ªëc ƒë·ªô
				end
			end
		end

		task.wait(30)
	end
end

---------------- üß© LU·ªíNG 6: Auto Rebirth khi ƒë·ªß 169 tile ----------------
local function startAutoRebirth()
	local plotIndex = 1
	local threshold = 169
	local delay = 2 -- th·ªùi gian ki·ªÉm tra l·∫°i (gi√¢y)

	local PlotsInvoke = ReplicatedStorage:WaitForChild("Network"):WaitForChild("Plots_Invoke")
	local PlotsFolder = Workspace:WaitForChild("__THINGS"):WaitForChild("Plots")

	while true do
		local plot = PlotsFolder:FindFirstChild(tostring(plotIndex))
		if plot and plot:FindFirstChild("Tiles") then
			local tileCount = #plot.Tiles:GetChildren()
			if tileCount >= threshold then
				local args = {plotIndex, "Rebirth"}
				pcall(function()
					PlotsInvoke:InvokeServer(unpack(args))
				end)
			end
		end
		task.wait(delay)
	end
end

---------------- üîÅ K√≠ch ho·∫°t c·∫£ 6 lu·ªìng song song ----------------
task.spawn(startAutoPurchase)
task.spawn(startClaimAndOpen)
task.spawn(startClaimAndUnlock)
task.spawn(startAutoPlantDiamond)
task.spawn(startAutoHatchHuge)
task.spawn(startAutoRebirth)
