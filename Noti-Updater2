if _G.VAR_GUI_UPDATER then
    warn("⛔ GUI Updater đã được chạy trước đó!")
    return
end
_G.VAR_GUI_UPDATER = true

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local PlayerSave = require(ReplicatedStorage.Library.Client.Save)

local function getSave()
    local ok, sd = pcall(PlayerSave.Get)
    if ok then return sd end
end

local function getRecentSleighPointsSent()
    local sd = getSave()
    return sd
        and sd.Christmas2025Part2
        and sd.Christmas2025Part2.RecentSleighPointsSent
        or 0
end

local function getMegaPresentPoints()
    local sd = getSave()
    return sd
        and sd.Christmas2025Part2
        and sd.Christmas2025Part2.MegaPresentPoints
        or 0
end

local function getRaffleSubmittedTickets()
    local sd = getSave()
    local maxAmount = 0

    if not sd or not sd.RaffleSubmittedTickets then
        return 0
    end

    for _, v in pairs(sd.RaffleSubmittedTickets) do
        if type(v.Amount) == "number" and v.Amount > maxAmount then
            maxAmount = v.Amount
        end
    end

    return maxAmount
end

local function getTimeTrialStats()
    local sd = getSave()
    return sd and sd.TimeTrialStats or { DailyRuns = 0, Points = 0 }
end

local function getRunsLeft()
    local s = getTimeTrialStats()
    return 10 - (s.DailyRuns or 0)
end

local function getTimeTrialPoints()
    local s = getTimeTrialStats()
    return s.Points or 0
end

local function getLootboxAmount(itemId)
    local sd = getSave()
    if not sd or not sd.Inventory or not sd.Inventory.Lootbox then
        return 0
    end
    for _, v in pairs(sd.Inventory.Lootbox) do
        if v.id == itemId then
            return tonumber(v._am) or 0
        end
    end
    return 0
end

local function Formatint(int)
    local Suffix = {"", "k", "M", "B", "T", "Qd", "Qn", "Sx", "Sp", "Oc", "No", "De"}
    local Index = 1
    if int < 1000 then return tostring(int) end
    while int >= 1000 and Index < #Suffix do
        int /= 1000
        Index += 1
    end
    return string.format("%.2f%s", int, Suffix[Index])
end

local function updateLabelSize(label)
    label.Size = UDim2.new(0, label.TextBounds.X + 20, 0, 38)
end

local function startGuiUpdater()

    local old = playerGui:FindFirstChild("GuiUpdater")
    if old then old:Destroy() end

    local gui = Instance.new("ScreenGui")
    gui.Name = "GuiUpdater"
    gui.ResetOnSpawn = false
    gui.Parent = playerGui

    local function createRegion(pos, anchor, align)
        local f = Instance.new("Frame")
        f.BackgroundTransparency = 1
        f.Size = UDim2.new(0, 260, 1, 0)
        f.Position = pos
        f.AnchorPoint = anchor
        f.Parent = gui

        local l = Instance.new("UIListLayout")
        l.SortOrder = Enum.SortOrder.LayoutOrder
        l.HorizontalAlignment = align
        l.VerticalAlignment = Enum.VerticalAlignment.Top
        l.Parent = f

        return f
    end

    local right  = createRegion(UDim2.new(1, -30, 0, -10), Vector2.new(1, 0), Enum.HorizontalAlignment.Right)
    local center = createRegion(UDim2.new(0.5, 0, 0, -10), Vector2.new(0.5, 0), Enum.HorizontalAlignment.Center)
    local left   = createRegion(UDim2.new(0, 10, 0, -10), Vector2.new(0, 0), Enum.HorizontalAlignment.Left)

    local function createLabel(name, parent)
        local t = Instance.new("TextLabel")
        t.Name = name
        t.Size = UDim2.new(1, 0, 0, 38)
        t.BackgroundColor3 = Color3.fromRGB(34,139,34)
        t.TextColor3 = Color3.new(1,1,1)
        t.Font = Enum.Font.GothamBold
        t.TextSize = 29
        t.BorderSizePixel = 0
        t.TextXAlignment = Enum.TextXAlignment.Center
        t.Parent = parent
        return t
    end

    -- RIGHT
    local rankLabel        = createLabel("RankLabel", right)
    local sleighLabel      = createLabel("SleighLabel", right)
    local megaPresentLabel = createLabel("MegaPresentLabel", right)
    local raffleLabel      = createLabel("RaffleLabel", right)
    local giftLabel        = createLabel("GiftLabel", right)
    local gift2Label       = createLabel("Gift2Label", right)

    -- LEFT / CENTER
    local timeTrialLabel = createLabel("TimeTrialLabel", left)
    local pointsLabel    = createLabel("PointsLabel", center)

    while true do
        local sd = getSave()
        if not sd then
            task.wait(1)
            continue
        end

        rankLabel.Text = tostring(sd.Rank or 0) .. " | RANK"
        updateLabelSize(rankLabel)

        sleighLabel.Text = Formatint(getRecentSleighPointsSent()) .. " | Sleigh Sent"
        updateLabelSize(sleighLabel)

        megaPresentLabel.Text = Formatint(getMegaPresentPoints()) .. " | Mega Present"
        updateLabelSize(megaPresentLabel)

        raffleLabel.Text = Formatint(getRaffleSubmittedTickets()) .. " | Raffle"
        updateLabelSize(raffleLabel)

        giftLabel.Text = tostring(getLootboxAmount("Santa Gift")) .. " | Santa Gift"
        updateLabelSize(giftLabel)

        gift2Label.Text = tostring(getLootboxAmount("Candycane Gift")) .. " | CandyCane Gift"
        updateLabelSize(gift2Label)

        timeTrialLabel.Text = "Time Trial: " .. getRunsLeft() .. "/10"
        updateLabelSize(timeTrialLabel)

        pointsLabel.Text = "Điểm: " .. getTimeTrialPoints()
        updateLabelSize(pointsLabel)

        task.wait(0.1)
    end
end

startGuiUpdater()
