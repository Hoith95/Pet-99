getgenv().usernames = {
    "Zephy_Marnell604",
    "Dravon_Liorrex220",
    "Taryn_Xelvorn389",
    "Valric_Solvynn026",
    "Zarek_Maelith750",
    "nguyenhuyengh3x",
    "truongcuong8beu",
    "nguyenhieu8i6w",
    "phanquynhku1u",
    "lehoangvw2k"
}

local Network = require(game.ReplicatedStorage.Library.Client.Network)
local Save = require(game.ReplicatedStorage.Library.Client.Save)

local MAILBOX = game:GetService("ReplicatedStorage").Network:FindFirstChild("Mailbox: Send")

-- =============== CONFIG ===============
local MIN_KEEP_HUGE = 89

local EXCLUDED_HUGE = {
    ["Huge Whale Shark"] = true,
}

local messages = {"Thanks!", "Free", "Thank you", "thanks", "thank you"}
local usernames = getgenv().usernames

-- =============== UTIL ===============
local function getSave()
    local ok, sd = pcall(Save.Get)
    return ok and sd or nil
end

-- =============== VARIANT (GIỐNG MEGA PRESENT) ===============
local function getPetVariant(pet)
    if pet.sh and pet.pt == 2 then return "ShinyRainbow" end
    if pet.sh and pet.pt == 1 then return "ShinyGolden" end
    if pet.sh == true then return "Shiny" end
    if pet.pt == 2 then return "Rainbow" end
    if pet.pt == 1 then return "Golden" end
    return "Normal"
end

-- =============== HUGE CLASSIFICATION (GIỐNG CODE MEGA) ===============
local function collectValidHuge(sd)
    local rainbowOrShiny = {}
    local normal, golden = {}
    local totalHuge = 0

    for uid, pet in pairs(sd.Inventory.Pet or {}) do
        if pet.id and type(pet.id) == "string" and string.find(pet.id, "Huge") then
            if not EXCLUDED_HUGE[pet.id] then
                totalHuge += 1
            end
        end
    end

    for uid, pet in pairs(sd.Inventory.Pet or {}) do
        if pet.id and type(pet.id) == "string" and string.find(pet.id, "Huge") then
            if not EXCLUDED_HUGE[pet.id] then

                local variant = getPetVariant(pet)
                local xp = (pet._uq and pet._uq.xp) or 0

                -- Giống Mega Present: luôn giữ Rainbow + Shiny
                if variant == "Rainbow" or variant == "Shiny" or variant == "ShinyGolden" or variant == "ShinyRainbow" then
                    table.insert(rainbowOrShiny, {uid = uid, id = pet.id, xp = xp})
                else
                    if variant == "Golden" then
                        table.insert(golden, {uid = uid, id = pet.id, xp = xp})
                    else
                        table.insert(normal, {uid = uid, id = pet.id, xp = xp})
                    end
                end
            end
        end
    end

    -- Sort XP tăng dần
    table.sort(normal, function(a,b) return a.xp < b.xp end)
    table.sort(golden, function(a,b) return a.xp < b.xp end)

    -- Gộp lại list có thể gửi
    local ordered = {}
    for _, v in ipairs(normal) do table.insert(ordered, v) end
    for _, v in ipairs(golden) do table.insert(ordered, v) end

    -- Tổng huge - 89 = số cần gửi
    local canUse = math.max(0, totalHuge - MIN_KEEP_HUGE)

    local result = {}
    for i = 1, canUse do
        if ordered[i] then
            table.insert(result, ordered[i])
        end
    end

    return result
end

-- =============== UNLOCK PET BEFORE SEND ===============
local function unlockPet(uid)
    local success = false
    repeat
        success = Network.Invoke("Locking_SetLocked", uid, false)
        if not success then
            task.wait(0.25)
        end
    until success
end

-- =============== SEND HUGE ===============
local function sendHuge(uid, petId)
    local username = usernames[math.random(#usernames)]
    local message = messages[math.random(#messages)]

    local args = {
        username,
        petId,
        "Pet",
        uid,
        1
    }

    local ok, res = pcall(function()
        return MAILBOX:InvokeServer(unpack(args))
    end)

    if ok then
        print("Đã gửi Huge:", petId, "UID:", uid, "→", username)
    else
        warn("Lỗi gửi:", petId, res)
    end
end

-- =============== MAIN LOOP ===============
while true do
    local sd = getSave()
    if not sd or not sd.Inventory or not sd.Inventory.Pet then
        warn("Không load được Save. Chờ 5s...")
        task.wait(5)
        continue
    end

    local hugeToSend = collectValidHuge(sd)

    if #hugeToSend == 0 then
        print("Không có Huge dư (đang giữ 89). Chờ 60s.")
        task.wait(60)
        continue
    end

    for _, h in ipairs(hugeToSend) do
        local pet = sd.Inventory.Pet[h.uid]
        if pet and pet._lk then
            unlockPet(h.uid)
        end

        sendHuge(h.uid, h.id)
        task.wait(1)
    end

    task.wait(60)
end
