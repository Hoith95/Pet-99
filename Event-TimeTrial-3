-- N·∫øu script ƒë√£ ch·∫°y tr∆∞·ªõc ƒë√≥ th√¨ tho√°t
if _G.VAR_TIME_TRIAL then
    warn("‚õî Script ƒë√£ ƒë∆∞·ª£c ch·∫°y tr∆∞·ªõc ƒë√≥!")
    return
end

_G.VAR_TIME_TRIAL = true
_G.STOP_TIME_TRIAL = false

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local Save = require(ReplicatedStorage.Library.Client.Save)
local ZoneCmds = require(ReplicatedStorage.Library.Client.ZoneCmds)

local lagFlag = false
local endFlag = false
local lagMonitorThread, increaseMonitorThread, monitor12minThread

-- üõ°Ô∏è L·∫•y HumanoidRootPart an to√†n
local function getHumanoidRootPart()
	local character = player.Character or player.CharacterAdded:Wait()
	if not character then return nil end

	local hrp = character:FindFirstChild("HumanoidRootPart")
	local waitTime = 0
	while not hrp and waitTime < 5 do
		task.wait(0.5)
		waitTime += 0.5
		hrp = character:FindFirstChild("HumanoidRootPart")
	end

	return hrp
end

-- H√†m helper l·∫•y data an to√†n, retry t·ªëi ƒëa 3 l·∫ßn r·ªìi tr·∫£ v·ªÅ m·∫∑c ƒë·ªãnh
local function safeFetchSave()
    for i = 1, 3 do
        local ok, data = pcall(Save.Get)
        if ok and data and data.TimeTrialStats then
            return data.TimeTrialStats
        end
        task.wait(1)
    end
    -- N·∫øu 3 l·∫ßn v·∫´n kh√¥ng h·ª£p l·ªá, tr·∫£ v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh
    return {
        DailyRuns = 0,
        Points    = 0,
        TotalRuns = 0,
    }
end

-- -> D√πng l·∫°i cho t·∫•t c·∫£
local function getRunsUsed()
    local stats = safeFetchSave()
    return stats.DailyRuns or 0
end

local function getRunsLeft()
    return 10 - getRunsUsed()
end

local function getTimeTrialPoints()
    local stats = safeFetchSave()
    return stats.Points or 0
end

local function getTotalRuns()
    local stats = safeFetchSave()
    return stats.TotalRuns or 0
end

-- üó∫Ô∏è Teleport h·ªó tr·ª£
local function teleportTo(part)
	local hrp = getHumanoidRootPart()
	if hrp and part and part.CFrame then
		hrp.CFrame = part.CFrame + Vector3.new(0, 5, 0)
	end
end

local function teleportToRewardLocation()
	warn("üö∂‚Äç‚ôÇÔ∏è ƒêang teleport ƒë·∫øn v·ªã tr√≠ ƒë·ªïi qu√†...")
	local hrp = getHumanoidRootPart()
	if hrp then
		hrp.CFrame = CFrame.new(-14221, 17.39, 2210)
	end
end

local function teleportToLocation()
	warn("üö∂‚Äç‚ôÇÔ∏è ƒêang teleport v·ªÅ v·ªã tr√≠ map 269...")
	local hrp = getHumanoidRootPart()
	if hrp then
		hrp.CFrame = CFrame.new(-14251, 17.39, 2154)
	end
end

local function safeTeleportOut()
	teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Leave)
	task.wait(9)
	if increaseMonitorThread then pcall(task.cancel, increaseMonitorThread) increaseMonitorThread = nil end
	if lagMonitorThread then pcall(task.cancel, lagMonitorThread) lagMonitorThread = nil end
end

-- üîç L·∫•y Max Zone t·ª´ Map4
local function getMaxZoneFromMap4()
	local mapFolder = workspace:FindFirstChild("Map4")
	if not mapFolder then return 0 end

	local maxZone = 0
	for _, folder in ipairs(mapFolder:GetChildren()) do
		if folder:IsA("Folder") then
			local zoneNumber = tonumber(folder.Name:match("^(%d+)"))
			if zoneNumber and zoneNumber > maxZone then
				maxZone = zoneNumber
			end
		end
	end
	return maxZone
end

-- üïê Ch·ªù ƒë·∫øn khi ƒë·∫°t Max Zone
local function waitUntilReachMaxZone(useCustomZone)
	local maxMapZone = useCustomZone and 269 or getMaxZoneFromMap4()

	while true do
		local success, data = pcall(function()
			local _, zoneData = ZoneCmds.GetMaxOwnedZone()
			return zoneData
		end)

		local current = success and data and data.ZoneNumber or 0

		if current >= maxMapZone then
			warn("‚úÖ ƒê√£ ƒë·∫°t Zone t·ªëi ƒëa (" .. tostring(current) .. ")")
			break
		else
			warn("‚è≥ Ch∆∞a ƒë·∫°t Zone t·ªëi ƒëa (" .. tostring(current) .. "/" .. tostring(maxMapZone) .. "), ƒë·ª£i 60s...")
			task.wait(60)
		end
	end
end

-- üß™ G·ªçi h√†m v·ªõi t√πy ch·ªçn
--waitUntilReachMaxZone(true)  -- D√πng zone c·ªë ƒë·ªãnh 269
waitUntilReachMaxZone(false) -- D√πng zone l·∫•y t·ª´ Map4

-- Monitor 12 ph√∫t kh√¥ng tƒÉng l∆∞·ª£t ho·∫∑c ƒëi·ªÉm
local function startMonitor12Min()
    monitor12minThread = task.spawn(function()
        local lastRuns = getRunsUsed()
        local lastPoints = getTimeTrialPoints()
        local timer = 0
        local teleportCount = 0

        while true do
            if getRunsUsed() >= 10 then
                return
            end

            task.wait(10)
            timer += 10

            local curRuns = getRunsUsed()
            local curPoints = getTimeTrialPoints()
            local runChanged = (curRuns ~= lastRuns or curPoints ~= lastPoints)
            local teleportEvent = (endFlag or lagFlag)

            if runChanged or teleportEvent then
                if teleportEvent and not runChanged then
                    teleportCount += 1
                    warn("‚ö†Ô∏è Teleport out m√† kh√¥ng ƒë·ªïi l∆∞·ª£t/ƒëi·ªÉm l·∫ßn " .. teleportCount)
                    if teleportCount > 7 then
                        player:Kick("‚è∞ Qu√° 7 l·∫ßn teleport out m√† kh√¥ng ƒë·ªïi l∆∞·ª£t ‚Üí nghi ng·ªù treo m√°y.")
                        return
                    end
                end

                if runChanged then
                    teleportCount = 0
                end

                lastRuns = curRuns
                lastPoints = curPoints
                timer = 0
                endFlag = false
                lagFlag = false

                warn("üîÑ Reset monitor12min do c√≥ ho·∫°t ƒë·ªông trong Time Trial.")
            end

            if timer >= 720 then
                player:Kick("‚è∞ 12 ph√∫t kh√¥ng ƒë·ªïi l∆∞·ª£t ho·∫∑c ƒëi·ªÉm ‚Üí nghi ng·ªù treo m√°y.")
                return
            end
        end
    end)
end

-- Theo d√µi ƒë·ª©ng y√™n (lag)
local function startLagMonitor()
    lagMonitorThread = task.spawn(function()
        local retryCount = 0

        while true do
            local hrp = getHumanoidRootPart()
            if not hrp then
                task.wait(5)
                continue
            end

            local lastPos = hrp.Position
            task.wait(60)
            local currPos = hrp.Position

            if (lastPos - currPos).Magnitude < 1 then
                retryCount += 1
                warn("‚ö†Ô∏è ƒê·ª©ng im " .. retryCount .. " l·∫ßn")

                if retryCount > 3 then
                    player:Kick("Lag qu√° l√¢u trong Time Trial.")
                    return
                else
                    lagFlag = true
                    safeTeleportOut()
                    return
                end
            else
                retryCount = 0
            end

            task.wait(5)
        end
    end)
end

-- Theo d√µi tƒÉng ƒëi·ªÉm/TotalRuns
local function startIncreaseMonitor(startPoints, startRuns)
    increaseMonitorThread = task.spawn(function()
        warn("‚è≥ Theo d√µi tƒÉng ƒêi·ªÉm/TotalRuns")
        while true do
            if lagFlag then
                return
            end
            if getTimeTrialPoints() > startPoints or getTotalRuns() > startRuns then
                warn("‚úÖ ƒêi·ªÉm ho·∫∑c TotalRuns tƒÉng ‚Üí ƒê√°nh d·∫•u endFlag")
                endFlag = true
                return
            end
            task.wait(1)
        end
    end)
end

-- üîÅ Teleport farm breakables
local function teleportFarmLoop(startPoints, startRuns)
	while true do
		if lagFlag or endFlag or _G.STOP_TIME_TRIAL then
			warn("‚ö†Ô∏è D·ª´ng teleportFarmLoop")
			return
		end

		-- üîç Ki·ªÉm tra nh√¢n v·∫≠t ƒë√£ h·ªìi sinh v√† c√≥ HRP ch∆∞a
		local hrp = getHumanoidRootPart()
		if not hrp then
			warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y HumanoidRootPart ‚Üí ƒë·ª£i h·ªìi sinh...")
			task.wait(3)
			continue
		end

		local names = {}
		for _, c in ipairs(workspace.__THINGS.Breakables:GetChildren()) do
			if c:IsA("Model") and tonumber(c.Name) then
				table.insert(names, c.Name)
			end
		end

		if #names > 0 then
			for _, n in ipairs(names) do
				if lagFlag or endFlag or _G.STOP_TIME_TRIAL then return end
				local b = workspace.__THINGS.Breakables:FindFirstChild(n)
				if b then
					local p = b:FindFirstChildWhichIsA("BasePart")
					if p then
						teleportTo(p)
						while workspace.__THINGS.Breakables:FindFirstChild(n) do
							if lagFlag or endFlag or _G.STOP_TIME_TRIAL then return end
							task.wait(0.1)
						end
					end
				end
			end
		else
			warn("‚è≥ Kh√¥ng c√≥ r∆∞∆°ng, ch·ªù 20s...")
			local found = false
			for i = 1, 200 do
				if lagFlag or endFlag or _G.STOP_TIME_TRIAL then return end
				task.wait(0.1)
				for _, c in ipairs(workspace.__THINGS.Breakables:GetChildren()) do
					if c:IsA("Model") and tonumber(c.Name) then
						found = true
						break
					end
				end
				if found then break end
			end
			if not found then
				warn("‚ùå H·∫øt r∆∞∆°ng ‚Üí k·∫øt th√∫c l∆∞·ª£t")
				endFlag = true
				return
			end
		end

		task.wait(0.1)
	end
end

-- Cleanup threads
local function cleanupAllThreads()
    warn("üßπ Cleanup to√†n b·ªô thread & tr·∫°ng th√°i")
    if lagMonitorThread then pcall(task.cancel, lagMonitorThread); lagMonitorThread = nil end
    if increaseMonitorThread then pcall(task.cancel, increaseMonitorThread); increaseMonitorThread = nil end
    if monitor12minThread then pcall(task.cancel, monitor12minThread); monitor12minThread = nil end
    lagFlag = false
    endFlag = false
    _G.STOP_TIME_TRIAL = false
    _G.VAR_TIME_TRIAL = nil
end

-- üéÅ ƒê·ªïi qu√†
local function claimReward()
    warn("üéÅ B·∫Øt ƒë·∫ßu ƒë·ªïi qu√†...")

    -- üìä L·∫•y ƒëi·ªÉm Time Trial
    local points = getTimeTrialPoints()

    -- üìÜ Gi·ªù Vi·ªát Nam (UTC+7)
    local now = os.date("!*t", os.time(os.date("!*t")) + 7 * 3600)
    local currentDay = now.wday
    local currentHour = now.hour

    -- N·∫øu Th·ª© 7 tr∆∞·ªõc 23h th√¨ ƒë·ªïi h·∫øt, ng∆∞·ª£c l·∫°i ch·ªâ ƒë·ªïi h·ªôp 3
    local isSaturdayFull = (currentDay == 7) and (currentHour < 23)

    -- T√≠nh s·ªë l∆∞·ª£ng t·ª´ng lo·∫°i h·ªôp
    local chest3, chest2, chest1 = 0, 0, 0
    if isSaturdayFull then
        warn("üìÜ H√¥m nay l√† Th·ª© 7 (gi·ªù VN) v√† ch∆∞a t·ªõi 23h ‚Üí ƒê·ªïi h·∫øt to√†n b·ªô ƒëi·ªÉm.")
        chest3 = math.floor(points / 5000)
        points = points - chest3 * 5000
        chest2 = math.floor(points / 3000)
        points = points - chest2 * 3000
        chest1 = math.floor(points / 1000)
    else
        warn("üìÜ Ch·ªâ ƒë·ªïi h·ªôp 3 (Th·ª© 7 sau 23h ho·∫∑c kh√¥ng ph·∫£i Th·ª© 7 - gi·ªù VN).")
        chest3 = math.floor(points / 5000)
    end

    warn("üßæ S·ªë l·∫ßn ƒë·ªïi qu√† s·∫Ω th·ª±c hi·ªán:")
    warn("üì¶ H·ªôp 3 (5000): " .. chest3)
    warn("üì¶ H·ªôp 2 (3000): " .. chest2)
    warn("üì¶ H·ªôp 1 (1000): " .. chest1)

    local totalChests = chest3 + chest2 + chest1
    if totalChests == 0 then
        warn("‚ö†Ô∏è Kh√¥ng c√≥ ph·∫ßn th∆∞·ªüng n√†o ƒë·ªß ƒëi·ªÉm ƒë·ªÉ ƒë·ªïi.")
        return
    end

    local function openChest(chestType)
        local args = { [1] = chestType }
        return ReplicatedStorage.Network.TimeTrials_OpenChest:InvokeServer(unpack(args))
    end

    local function isAtExactRewardPosition()
        local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then return false end
        local target = Vector3.new(-14221, 17.39, 2210)
        return (hrp.Position - target).Magnitude <= 2
    end

    local function claimMultiple(count, chestType)
        for i = 1, count do
            warn("üîÅ ƒêang th·ª±c hi·ªán ƒë·ªïi h·ªôp " .. chestType .. " - l·∫ßn " .. i)
            local success, err = pcall(function()
                openChest(chestType)
            end)
            if success then
                warn("‚úÖ ƒê·ªïi th√†nh c√¥ng h·ªôp " .. chestType .. " - l·∫ßn " .. i)
            else
                warn("‚ùå L·ªói khi ƒë·ªïi h·ªôp " .. chestType .. ": " .. tostring(err))
            end

            task.wait(5)
            if not isAtExactRewardPosition() then
                warn("‚ö†Ô∏è Sai v·ªã tr√≠ sau khi ƒë·ªïi h·ªôp " .. chestType .. " ‚Üí teleport l·∫°i.")
                teleportToRewardLocation()
                task.wait(9)
                if not isAtExactRewardPosition() then
                    warn("‚õî V·∫´n sai v·ªã tr√≠, b·ªè qua ki·ªÉm tra l·∫ßn n√†y.")
                else
                    warn("‚úÖ ƒê√£ tr·ªü l·∫°i ƒë√∫ng v·ªã tr√≠ ƒë·ªïi.")
                end
            end
        end
    end

    local retry = 0
    while retry < 3 do
        retry += 1
        warn("üö∂‚Äç‚ôÇÔ∏è Teleport t·ªõi v·ªã tr√≠ ƒë·ªïi qu√† (l·∫ßn " .. retry .. ")...")
        teleportToRewardLocation()
        task.wait(9)
        if isAtExactRewardPosition() then
            warn("‚úÖ V·ªã tr√≠ ch√≠nh x√°c ‚Üí b·∫Øt ƒë·∫ßu ƒë·ªïi qu√†.")
            break
        else
            warn("‚ùå V·ªã tr√≠ sai ‚Üí th·ª≠ l·∫°i.")
        end
    end

    if not isAtExactRewardPosition() then
        warn("‚õî Kh√¥ng th·ªÉ ƒë·∫øn ƒë√∫ng v·ªã tr√≠ sau 3 l·∫ßn th·ª≠ ‚Üí b·ªè qua ƒë·ªïi qu√†.")
        return
    end

    claimMultiple(chest3, 3)
    claimMultiple(chest2, 2)
    claimMultiple(chest1, 1)

    task.wait(9)
    teleportToLocation()
end

-- üîÑ Auto-claim song song, ch·∫°y m·ªói 15 ph√∫t
local function startAutoClaim()
    task.spawn(function()
        while true do
            task.wait(15 * 60)

            local pts = getTimeTrialPoints()

            -- Gi·ªù VN
            local d = os.date("!*t", os.time(os.date("!*t")) + 7 * 3600)
            local can = (d.wday == 7 and d.hour < 23 and pts >= 1000)
                    or (d.wday ~= 7 and pts >= 5000)

            if can then
                warn("üîî Auto-claim: ƒë·ªß ƒëi·ªÅu ki·ªán (gi·ªù VN) ‚Üí ch·∫°y claimReward().")
                claimReward()
            else
                warn("‚ÑπÔ∏è Auto-claim: ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán (gi·ªù VN) (Points="..pts..").")
            end
        end
    end)
end

-- V√≤ng l·∫∑p ch√≠nh
spawn(function()
    waitUntilReachMaxZone(false)
    startMonitor12Min()

    while getRunsUsed() < 10 do
        lagFlag = false
        endFlag = false

        local used = getRunsUsed()
        if used > 0 then
            warn("‚è∏Ô∏è Ngh·ªâ 30s tr∆∞·ªõc l∆∞·ª£t ti·∫øp theo...")
            task.wait(30)
        end

        local startPoints, startRuns = getTimeTrialPoints(), getTotalRuns()

        warn("üîÅ B·∫Øt ƒë·∫ßu l∆∞·ª£t: "..used)
        teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Enter)
        task.wait(5)

        -- Th·ª≠ l·∫°i n·∫øu ch∆∞a v√†o Trial
        local retry = 0
        while not workspace.__THINGS.__INSTANCE_CONTAINER.Active:FindFirstChild("TimeTrial") and retry < 3 do
            retry += 1
            warn("‚ùå V√†o th·∫•t b·∫°i, th·ª≠ l·∫°i...")
            teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Enter)
            task.wait(5)
        end
        if not workspace.__THINGS.__INSTANCE_CONTAINER.Active:FindFirstChild("TimeTrial") then
            warn("‚õî Kh√¥ng th·ªÉ v√†o Time Trial.")
            cleanupAllThreads()
            return
        end

        startLagMonitor()
        startIncreaseMonitor(startPoints, startRuns)
        teleportFarmLoop(startPoints, startRuns)

        if endFlag then
            warn("üö™ K·∫øt th√∫c l∆∞·ª£t ‚Üí teleport out")
            safeTeleportOut()
        end

        task.wait(5)
        if lagMonitorThread then pcall(task.cancel, lagMonitorThread); lagMonitorThread = nil end
        if increaseMonitorThread then pcall(task.cancel, increaseMonitorThread); increaseMonitorThread = nil end
    end

    warn("üéâ Ho√†n t·∫•t 10/10 l∆∞·ª£t Time Trial.")
    claimReward()
    task.wait(30)
    cleanupAllThreads()

    -- Sau khi farm xong, ch·∫°y Event Block Party
    warn("üîÑ Kh·ªüi ƒë·ªông Event Block Party sau 10/10 l∆∞·ª£t.")
    spawn(function()
        _G.VAR_STOP_BLOCK_PARTY = false
        _G.VAR_START_BLOCK_PARTY = true
        loadstring(game:HttpGet("https://raw.githubusercontent.com/Hoith95/Pet-99/main/Event-Block-Party-3"))()
    end)

    -- Theo d√µi reset DailyRuns ƒë·ªÉ ti·∫øp t·ª•c farm
    warn("‚è≥ Theo d√µi reset DailyRuns...")
    while getRunsUsed() >= 10 do
        task.wait(60)
    end

		warn("üîÅ DailyRuns reset ‚Üí ti·∫øp t·ª•c farm.")
		if monitor12minThread then pcall(task.cancel, monitor12minThread) monitor12minThread = nil end
		_G.VAR_STOP_BLOCK_PARTY = true
		_G.VAR_START_BLOCK_PARTY = false
		task.wait(5)
		startMonitor12Min()
	end
end)
