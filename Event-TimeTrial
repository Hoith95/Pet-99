if game.PlaceId ~= 140403681187145 then return end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Save = require(ReplicatedStorage.Library.Client.Save)
local TimeTrials = require(ReplicatedStorage.Library.Types.TimeTrials)

local function teleportTo(part)
	local character = LocalPlayer.Character
	if character and character:FindFirstChild("HumanoidRootPart") and part and part:IsA("BasePart") then
		character.HumanoidRootPart.CFrame = part.CFrame
	end
end

local function isInsideXRegion()
	local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return false end
	local x = hrp.Position.X
	return x >= -18425 and x <= -18415
end

local function waitUntilEnterRegion(timeout)
	local start = tick()
	while tick() - start < timeout do
		if isInsideXRegion() then
			warn("✅ Đã vào vùng X, bắt đầu phá Breakables...")
			return true
		end
		task.wait(0.5)
	end
	return false
end

local function getBreakables()
	local breakables = {}
	for _, v in pairs(Workspace.__THINGS.Breakables:GetChildren()) do
		if v:IsA("Model") then
			table.insert(breakables, v)
		end
	end
	return breakables
end

local function teleportToBreakables()
	while true do
		local breakables = getBreakables()
		if #breakables == 0 then break end

		for _, breakable in ipairs(breakables) do
			local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
			if hrp and breakable and breakable:FindFirstChild("Main") then
				hrp.CFrame = breakable.Main.CFrame + Vector3.new(0, 5, 0)
				local name = breakable.Name
				warn("➡️ Đang phá: " .. name)

				local waitStart = tick()
				repeat
					task.wait(0.5)
				until not breakable.Parent or tick() - waitStart > 10
			end
		end
	end
end

local function restorePosition(cframe)
	task.wait(0.5)
	teleportTo({ CFrame = cframe })
end

-- MAIN
local runCount = 0
local failedAttempts = 0
local maxAttempts = 3

while runCount < 10 do
	local savedPosition = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.CFrame

	-- Teleport vào Time Trial
	teleportTo(Workspace.__THINGS.Instances.TimeTrial.Teleports.Enter)
	task.wait(5)

	if not waitUntilEnterRegion(10) then
		warn("❌ Không vào được vùng X.")
		break
	end

	local breakablesDone = false

	-- Task kiểm tra lag
	task.spawn(function()
		local startTick = tick()
		while tick() - startTick < 30 do
			if not isInsideXRegion() then return end
			task.wait(1)
		end

		if not breakablesDone then
			failedAttempts += 1
			warn("❌ Không thấy Breakables (lần thử " .. failedAttempts .. ")")

			local LeaveTeleport = Workspace.__THINGS.Instances.TimeTrial.Teleports:FindFirstChild("Leave")
			if LeaveTeleport then
				teleportTo(LeaveTeleport)
				task.wait(5)
			end

			task.wait(30)

			if failedAttempts >= maxAttempts then
				LocalPlayer:Kick("Tìm Breakables Méo Thấy")
			end
		end
	end)

	-- Task phá breakables
	task.spawn(function()
		teleportToBreakables()
		breakablesDone = true
	end)

	repeat task.wait(1) until breakablesDone

	-- Teleport ra
	teleportTo(Workspace.__THINGS.Instances.TimeTrial.Teleports.Leave)
	task.wait(5)

	if savedPosition then
		restorePosition(savedPosition)
	end

	runCount += 1
	warn("✅ Đã hoàn thành lần chạy thứ: " .. runCount)
	task.wait(15)
end

warn("🎉 Đã chạy đủ 10 lần. Kết thúc script.")
