if _G.VAR_TIME_TRIAL then
	warn("Script Ä‘Ã£ Ä‘Æ°á»£c cháº¡y trÆ°á»›c Ä‘Ã³!")
	return
end

_G.VAR_TIME_TRIAL = true

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local Save = require(game.ReplicatedStorage.Library.Client.Save)
local playerGui = player:WaitForChild("PlayerGui")
local oldGui = playerGui:FindFirstChild("TimeTrialGui")
if oldGui then oldGui:Destroy() end

local function getRunsLeft()
	local saveData = Save.Get()
	if saveData and saveData.TimeTrialStats then
		local usedRuns = saveData.TimeTrialStats.DailyRuns or 0
		return math.max(0, 10 - usedRuns)
	end
	return 0
end

local function getRunsUsed()
	local saveData = Save.Get()
	return saveData and saveData.TimeTrialStats and saveData.TimeTrialStats.DailyRuns or 0
end

local function getTimeTrialPoints()
	local saveData = Save.Get()
	if saveData and saveData.TimeTrialStats and type(saveData.TimeTrialStats.Points) == "number" then
		return saveData.TimeTrialStats.Points
	end
	return 0
end

local function createLabel(name, position, anchor, bgColor)
	local label = Instance.new("TextLabel")
	label.Name = name
	label.AnchorPoint = anchor or Vector2.new(0, 0)
	label.Position = position
	label.Size = UDim2.new(0, 0, 0, 38)
	label.BackgroundColor3 = bgColor
	label.TextColor3 = Color3.fromRGB(255, 255, 255)
	label.Font = Enum.Font.GothamBold
	label.TextSize = 32
	label.Text = "..."
	label.BackgroundTransparency = 0
	label.BorderSizePixel = 0
	label.TextXAlignment = Enum.TextXAlignment.Center
	label.Parent = screenGui
	return label
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "TimeTrialGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local pointsLabel = createLabel("PointsLabel", UDim2.new(0, 0, 0, -55), Vector2.new(0, 0), Color3.fromRGB(0, 128, 255))
local timeTrialLabel = createLabel("TimeTrialLabel", UDim2.new(0.5, 25, 0, -55), Vector2.new(0.5, 0), Color3.fromRGB(128, 0, 128))

local function updateLabelSize(label)
	label.Size = UDim2.new(0, label.TextBounds.X + 20, 0, 38)
end

task.spawn(function()
	while true do
		local runsLeft = getRunsLeft()
		local points = getTimeTrialPoints()

		pointsLabel.Text = "Äiá»ƒm: " .. tostring(points)
		updateLabelSize(pointsLabel)

		timeTrialLabel.Text = "Time Trial: " .. tostring(runsLeft) .. " / 10"
		updateLabelSize(timeTrialLabel)

		task.wait(10)
	end
end)
local _stuckRetries = 0
local stuckMonitorThread = nil

local function stopMonitorStuck()
	if stuckMonitorThread and coroutine.status(stuckMonitorThread) ~= "dead" then
		task.cancel(stuckMonitorThread)
	end
	stuckMonitorThread = nil
end

local function teleportTo(part)
	if part and part.CFrame then
		local character = player.Character or player.CharacterAdded:Wait()
		if character and character:FindFirstChild("HumanoidRootPart") then
			character.HumanoidRootPart.CFrame = part.CFrame + Vector3.new(0, 5, 0)
		end
	end
end

local function startMonitorStuck(onStuckCallback)
	if stuckMonitorThread then
		stopMonitorStuck()
	end

	stuckMonitorThread = task.spawn(function()
		local stationarySeconds = 0
		local lastPosition = nil

		while true do
			local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
			if not hrp then task.wait(1) continue end

			local currentPosition = hrp.Position
			if lastPosition and (currentPosition - lastPosition).Magnitude < 0.5 then
				stationarySeconds += 1
				if stationarySeconds >= 60 then
					warn("âš ï¸ NhÃ¢n váº­t Ä‘á»©ng yÃªn táº¡i 1 vá»‹ trÃ­ 60s â‡’ xá»­ lÃ½ stuck láº§n thá»© " .. tostring(_stuckRetries + 1))
					stopMonitorStuck()

					_stuckRetries += 1
					if _stuckRetries >= 3 then
						player:Kick("Äá»©ng yÃªn quÃ¡ 60s trong Time Trial (Ä‘Ã£ thá»­ láº¡i 3 láº§n)")
					else
						local Leave = workspace.__THINGS.Instances.TimeTrial.Teleports.Leave
						local Enter = workspace.__THINGS.Instances.TimeTrial.Teleports.Enter
						if Leave and Enter then
							teleportTo(Leave)
							task.wait(3)
							teleportTo(Enter)
							task.wait(5)
							if onStuckCallback then
								onStuckCallback()
							end
						end
					end
					break
				end
			else
				stationarySeconds = 0
				lastPosition = currentPosition
			end
			task.wait(1)
		end
	end)
end

local function getBreakables()
	local folder = workspace.__THINGS.Breakables
	local list = {}
	for _, v in ipairs(folder:GetChildren()) do
		if v:IsA("Model") and tonumber(v.Name) then
			table.insert(list, v.Name)
		end
	end
	return list
end

local function waitUntilGone(name)
	local folder = workspace.__THINGS.Breakables
	while folder:FindFirstChild(name) do
		task.wait(0.1)
	end
end

function farmBreakables()
	local BreakablesFolder = workspace.__THINGS.Breakables
	local LeaveTeleport = workspace.__THINGS.Instances.TimeTrial.Teleports.Leave
	local lastTotalRuns = getRunsUsed()

	while true do
		local list = getBreakables()
		if #list > 0 then
			for _, name in ipairs(list) do
				local m = BreakablesFolder:FindFirstChild(name)
				if m and m:IsA("Model") then
					local part = m:FindFirstChildWhichIsA("BasePart")
					if part then
						teleportTo(part)
						waitUntilGone(name)
					end
				end
			end
		else
			local changed = false
			for i = 1, 20 do
				task.wait(1)
				if #getBreakables() > 0 then
					changed = true
					break
				end
			end

			local currentTotal = getRunsUsed()
			if currentTotal > lastTotalRuns then
				warn("âœ… TotalRuns Ä‘Ã£ tÄƒng â†’ káº¿t thÃºc Time Trial")
				if LeaveTeleport then teleportTo(LeaveTeleport) end
				task.wait(3)
				return true
			elseif not changed then
				if LeaveTeleport then teleportTo(LeaveTeleport) end
				task.wait(3)
				return true
			end
		end
		task.wait(0.5)
	end
end
local function RunTimeTrialScript()
	task.spawn(function()
		if game.PlaceId ~= 140403681187145 then return end

		local ZoneCmds = require(game.ReplicatedStorage.Library.Client.ZoneCmds)
		local EnterTeleport = workspace.__THINGS.Instances.TimeTrial.Teleports.Enter
		local LeaveTeleport = workspace.__THINGS.Instances.TimeTrial.Teleports.Leave

		local _, maxZoneData = ZoneCmds.GetMaxOwnedZone()
		local requiredZoneNumber = maxZoneData and maxZoneData.ZoneNumber or 0

		while true do
			local _, currentZoneData = ZoneCmds.GetMaxOwnedZone()
			if currentZoneData and currentZoneData.ZoneNumber >= requiredZoneNumber then
				warn("âœ… ÄÃ£ Ä‘áº¡t Zone " .. requiredZoneNumber .. ", báº¯t Ä‘áº§u cháº¡y Time Trial.")
				break
			end
			warn("â³ ChÆ°a Ä‘áº¡t Zone " .. requiredZoneNumber .. ", Ä‘ang Ä‘á»£i...")
			task.wait(5)
		end

		task.spawn(function()
			while getTimeTrialPoints() <= 0 do
				print("â³ ChÆ°a cÃ³ Ä‘iá»ƒm Time Trial, chá» Ä‘áº¿n khi nháº­n Ä‘Æ°á»£c Ä‘iá»ƒm rá»“i má»›i theo dÃµi 12 phÃºt.")
				task.wait(10)
			end

			local currentRuns = getRunsUsed()
			if currentRuns >= 10 then
				warn("âœ… ÄÃ£ dÃ¹ng Ä‘á»§ 10 lÆ°á»£t, khÃ´ng cáº§n theo dÃµi thÃªm.")
				return
			end

			while currentRuns < 10 do
				local startRuns = currentRuns
				local totalTime = 0

				print("ğŸ•’ Theo dÃµi 12 phÃºt ká»ƒ tá»« lÆ°á»£t: " .. startRuns)

				while totalTime < 686 do
					task.wait(10)
					totalTime += 10

					currentRuns = getRunsUsed()
					if currentRuns >= 10 then
						warn("ğŸ‰ ÄÃ£ Ä‘áº¡t 10 lÆ°á»£t trong khi theo dÃµi.")
						return
					elseif currentRuns > startRuns then
						print("âœ… ÄÃ£ dÃ¹ng thÃªm lÆ°á»£t (tÄƒng tá»« " .. startRuns .. " â†’ " .. currentRuns .. "), theo dÃµi láº¡i tá»« Ä‘áº§u.")
						break
					end
				end

				if currentRuns == startRuns then
					player:Kick("â° 12 phÃºt rá»“i mÃ  khÃ´ng tÄƒng lÆ°á»£t Time Trial. CÃ³ thá»ƒ bá»‹ AFK hoáº·c lá»—i.")
					return
				end
			end
		end)

		local savedPosition = nil

		while true do
			local Daily_run = getRunsUsed()
			if Daily_run >= 10 then
				warn("ğŸ¯ ÄÃ£ Ä‘á»§ 10 lÆ°á»£t cháº¡y, dá»«ng script.")
				break
			end

			warn("ğŸ” Báº¯t Ä‘áº§u vÃ²ng Time Trial, lÆ°á»£t hiá»‡n táº¡i: " .. tostring(Daily_run))

			local character = player.Character or player.CharacterAdded:Wait()
			local hrp = character:FindFirstChild("HumanoidRootPart")
			if hrp then
				savedPosition = hrp.CFrame
			end

			teleportTo(EnterTeleport)
			task.wait(5)
			warn("ğŸšª ÄÃ£ teleport vÃ o Time Trial, Ä‘ang chuáº©n bá»‹ farm...")

			startMonitorStuck(function()
				warn("ğŸ” Retry sau stuck")
				startMonitorStuck()
				farmBreakables()
				stopMonitorStuck()
			end)

			farmBreakables()
			stopMonitorStuck()

			local afterRun = getRunsUsed()

			if LeaveTeleport then
				teleportTo(LeaveTeleport)
				task.wait(3)
			end

			warn("ğŸ‰ HoÃ n thÃ nh Time Trial, lÆ°á»£t Ä‘Ã£ dÃ¹ng: " .. tostring(afterRun))

			if savedPosition then
				local fakePart = Instance.new("Part")
				fakePart.Anchored = true
				fakePart.CFrame = savedPosition
				fakePart.Transparency = 1
				fakePart.CanCollide = false
				fakePart.Parent = workspace
				teleportTo(fakePart)
				task.delay(1, function() fakePart:Destroy() end)
				warn("ğŸ”™ Quay vá» vá»‹ trÃ­ ban Ä‘áº§u")
			end

			task.wait(15)
		end

		task.spawn(function()
			warn("ğŸ•“ Äang chá» DailyRuns reset Ä‘á»ƒ cháº¡y láº¡i script...")
			while true do
				task.wait(300)
				local newRun = getRunsUsed()
				if newRun < 10 then
					warn("ğŸ” DailyRuns Ä‘Ã£ reset â†’ cháº¡y láº¡i script!")
					_G.VAR_TIME_TRIAL = nil
					RunTimeTrialScript()
					break
				else
					print("â³ Váº«n chÆ°a reset, chá» thÃªm...")
				end
			end
		end)
	end)
end

RunTimeTrialScript()
