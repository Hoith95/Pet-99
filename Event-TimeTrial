task.spawn(function()
    if game.PlaceId ~= 140403681187145 then return end

    local player = game.Players.LocalPlayer
    local Save = require(game.ReplicatedStorage.Library.Client.Save)
    local TimeTrials = require(game.ReplicatedStorage.Library.Types.TimeTrials)

    local function teleportSequence(player, sequence)
        for _, cframe in ipairs(sequence) do
            local character = player.Character
            if character and character:FindFirstChild("HumanoidRootPart") then
                character.HumanoidRootPart.CFrame = cframe
                task.wait(0.3)  -- ⏱ chờ 0.5s giữa mỗi lần teleport
            else
                break
            end
        end
    end

    local function teleportTo(part)
        if part and part:IsA("BasePart") then
            local character = player.Character
            if character and character:FindFirstChild("HumanoidRootPart") then
                character.HumanoidRootPart.CFrame = part.CFrame
            end
        end
    end

    local function getDuration()
        local saveData = Save.Get()
        if not saveData then
            warn("Lỗi: Không lấy được dữ liệu save")
            return nil
        end

        local timeTrialStats = saveData.TimeTrialStats
        if not timeTrialStats then
            warn("Không tìm thấy TimeTrialStats")
            return 53
        end

        local totalRuns = timeTrialStats.TotalRuns or timeTrialStats.RemainingRuns or 0
        warn("Số lần Total Runs: " .. tostring(totalRuns))

        if totalRuns >= 10 then
            warn("Đã đủ 10 lượt, dừng thực hiện")
            return nil
        end

        local goalIndex = timeTrialStats.GoalIndex or 1
        local goal = TimeTrials.Goals[goalIndex]

        if not goal or not goal.Reward then return 250 end

        local success, amount = pcall(function()
            return goal.Reward:GetAmount()
        end)

        if success and typeof(amount) == "number" and math.floor(amount) == amount then
            return 53
        else
            return 250
        end
    end

    local teleportSequenceAll = {
        CFrame.new(-18079, 20, -484),
        CFrame.new(-18359, 20, -560),
        CFrame.new(-18306, 20, -695),
        CFrame.new(-18222, 20, -604),
        CFrame.new(-18221, 20, -458),
        CFrame.new(-18110, 20, -658),
    }

    local character = player.Character
    if not (character and character:FindFirstChild("HumanoidRootPart")) then
        warn("Character or HumanoidRootPart not found, aborting")
        return
    end

    while true do
        local duration = getDuration()
        if not duration or duration <= 0 or duration == 250 then
            warn("Duration không hợp lệ, kết thúc vòng lặp")
            break
        end

        -- Teleport vào Time Trial
        teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Enter)

        -- Chờ đến khi nhân vật vào map xác nhận theo X
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        while rootPart do
            local currentX = rootPart.Position.X
            if currentX >= -18425 and currentX <= -18415 then
                warn("Vào Time Trial thành công")
                break
            end
            task.wait(0.5)
        end

        local startTime = 0
        while startTime < duration do
            startTime += 1
            warn("Lần teleport thứ: " .. startTime)
            teleportSequence(player, teleportSequenceAll)
        end

        teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Leave)
        task.wait(15)
    end
end)
