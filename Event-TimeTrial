-- Auto Time Trial - Có nút bấm kết thúc bằng tay

task.spawn(function()
    if game.PlaceId ~= 140403681187145 then
        return
    end

    local player = game.Players.LocalPlayer
    local Save = require(game.ReplicatedStorage.Library.Client.Save)
    local TimeTrials = require(game.ReplicatedStorage.Library.Types.TimeTrials)

    local running = false -- Cờ trạng thái: đang chạy hay không

    -- Hàm teleport qua danh sách CFrame
    local function teleportSequence(player, sequence)
        for _, cframe in ipairs(sequence) do
            local character = player.Character
            if character and character:FindFirstChild("HumanoidRootPart") then
                character.HumanoidRootPart.CFrame = cframe
                task.wait(0.5)
            else
                break
            end
        end
    end

    -- Teleport đến một part cụ thể
    local function teleportTo(part)
        if part and part:IsA("BasePart") then
            local character = player.Character
            if character and character:FindFirstChild("HumanoidRootPart") then
                character.HumanoidRootPart.CFrame = part.CFrame
            end
        end
    end

    -- Lấy dữ liệu save để kiểm tra số lượt chạy
    local function canRunTrial()
        local saveData = Save.Get()
        if not saveData or not saveData.TimeTrialStats then
            return false
        end
        local totalRuns = saveData.TimeTrialStats.TotalRuns or 0
        return totalRuns < 10
    end

    -- Chuỗi các điểm teleport
    local teleportSequencePoints = {
        CFrame.new(-18079, 20, -484),
        CFrame.new(-18359, 20, -560),
        CFrame.new(-18306, 20, -695),
        CFrame.new(-18222, 20, -604),
        CFrame.new(-18221, 20, -458),
        CFrame.new(-18110, 20, -658),
    }

    -- Tạo GUI nút “KẾT THÚC”
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "TrialControlGui"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 120, 0, 40)
    button.Position = UDim2.new(0.5, -60, 0.9, 0)
    button.Text = "KẾT THÚC"
    button.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    button.TextColor3 = Color3.new(1,1,1)
    button.Font = Enum.Font.SourceSansBold
    button.TextSize = 20
    button.Parent = screenGui

    local stopSignal = false
    button.MouseButton1Click:Connect(function()
        stopSignal = true
        button.Text = "ĐANG THOÁT..."
        button.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    end)

    -- Bắt đầu vòng chính
    while true do
        if not canRunTrial() then
            warn("Đã đủ 10 lần hoặc không có dữ liệu, dừng script")
            break
        end

        stopSignal = false
        running = true

        -- Teleport vào Time Trial
        teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Enter)
        task.wait(5)

        -- Lặp teleport liên tục cho đến khi bạn bấm nút kết thúc
        while not stopSignal do
            teleportSequence(player, teleportSequencePoints)
        end

        -- Sau khi bạn bấm kết thúc → thoát khỏi Time Trial
        teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Leave)
        task.wait(15)

        button.Text = "KẾT THÚC"
        button.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    end

end)
