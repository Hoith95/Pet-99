-- Auto Time Trial cho map 264 - ƒë∆°n gi·∫£n, kh√¥ng ph√¢n bi·ªát k·∫øt qu·∫£
task.spawn(function()

    task.wait(5)

    if game.PlaceId ~= 140403681187145 then
        return
    end

    local player = game.Players.LocalPlayer
    local Save = require(game.ReplicatedStorage.Library.Client.Save)

    local stopSignal = false
    local FARM_POSITION = CFrame.new(1556, 36, -648) -- V·ªã tr√≠ farm

    -- Hook TimeTrialResultUI.Show ƒë·ªÉ ph√°t hi·ªán khi ho√†n th√†nh
    local success, timeTrialResultUI = pcall(function()
        return require(game.ReplicatedStorage.Library.Client.UI.TimeTrialResultUI)
    end)

    if success and typeof(timeTrialResultUI) == "table" and typeof(timeTrialResultUI.Show) == "function" then
        local originalShow = timeTrialResultUI.Show
        timeTrialResultUI.Show = function(arg1)
            warn("‚úÖ Time Trial k·∫øt th√∫c")
            stopSignal = true
            return originalShow(arg1)
        end
    else
        warn("‚ö†Ô∏è Kh√¥ng th·ªÉ hook v√†o TimeTrialResultUI.Show")
    end

    -- D·ªãch chuy·ªÉn qua c√°c ƒëi·ªÉm
    local function teleportSequence(player, sequence)
        for _, cframe in ipairs(sequence) do
            local character = player.Character
            if character and character:FindFirstChild("HumanoidRootPart") then
                character.HumanoidRootPart.CFrame = cframe
                task.wait(0.5)
            else
                break
            end
        end
    end

    -- D·ªãch chuy·ªÉn ƒë·∫øn part ho·∫∑c CFrame
    local function teleportTo(partOrCFrame)
        local character = player.Character
        if not character or not character:FindFirstChild("HumanoidRootPart") then return end

        if typeof(partOrCFrame) == "Instance" and partOrCFrame:IsA("BasePart") then
            character.HumanoidRootPart.CFrame = partOrCFrame.CFrame
        elseif typeof(partOrCFrame) == "CFrame" then
            character.HumanoidRootPart.CFrame = partOrCFrame
        end
    end

    -- Ki·ªÉm tra c√≤n l∆∞·ª£t Time Trial kh√¥ng
    local function canRunTrial()
        local saveData = Save.Get()
        if not saveData or not saveData.TimeTrialStats then return false end
        return (saveData.TimeTrialStats.TotalRuns or 0) < 10
    end

    -- Danh s√°ch c√°c ƒëi·ªÉm d·ªãch chuy·ªÉn trong map
    local teleportSequencePoints = {
        CFrame.new(-18079, 20, -484),
        CFrame.new(-18359, 20, -560),
        CFrame.new(-18306, 20, -695),
        CFrame.new(-18222, 20, -604),
        CFrame.new(-18221, 20, -458),
        CFrame.new(-18110, 20, -658),
    }

    -- V√≤ng l·∫∑p ch√≠nh
    while true do
        if not canRunTrial() then
            warn("üö´ ƒê√£ ƒë·ªß 10 l∆∞·ª£t ch·∫°y, d·ª´ng script.")
            break
        end

        stopSignal = false

        -- Teleport v√†o Time Trial
        teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Enter)
        task.wait(5)

        -- D·ªãch chuy·ªÉn v√≤ng quanh map
        while not stopSignal do
            teleportSequence(player, teleportSequencePoints)
        end

        -- Tho√°t kh·ªèi Time Trial
        teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Leave)
        task.wait(5)

        -- Teleport v·ªÅ ch·ªó farm (kh√¥ng c·∫ßn ph√¢n bi·ªát th·∫Øng/thua)
        teleportTo(FARM_POSITION)
        warn("üèïÔ∏è ƒê√£ quay v·ªÅ v·ªã tr√≠ farm.")

        task.wait(10)
    end

end)
