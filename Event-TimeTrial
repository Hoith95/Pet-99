-- Auto Time Trial cho map 264 - t·ª± ƒë·ªông tho√°t khi ho√†n th√†nh
task.spawn(function()
    if game.PlaceId ~= 140403681187145 then
        return
    end

    local player = game.Players.LocalPlayer
    local Save = require(game.ReplicatedStorage.Library.Client.Save)
    local TimeTrials = require(game.ReplicatedStorage.Library.Types.TimeTrials)

    -- G·∫Øn c·ªù ƒë·ªÉ ki·ªÉm so√°t v√≤ng l·∫∑p
    local stopSignal = false

    -- Hook v√†o UI k·∫øt qu·∫£ ƒë·ªÉ bi·∫øt khi n√†o tr·∫≠n ƒë·∫•u k·∫øt th√∫c
    local success, timeTrialResultUI = pcall(function()
        return require(game.ReplicatedStorage.Library.Client.UI.TimeTrialResultUI)
    end)

    if success and typeof(timeTrialResultUI) == "table" and typeof(timeTrialResultUI.Show) == "function" then
        local originalShow = timeTrialResultUI.Show
        timeTrialResultUI.Show = function(arg1)
            warn("‚è±Ô∏è Time Trial k·∫øt th√∫c, t·ª± ƒë·ªông tho√°t...")
            stopSignal = true
            return originalShow(arg1)
        end
    else
        warn("‚ö†Ô∏è Kh√¥ng th·ªÉ hook v√†o TimeTrialResultUI.Show")
    end

    -- H√†m teleport qua danh s√°ch ƒëi·ªÉm
    local function teleportSequence(player, sequence)
        for _, cframe in ipairs(sequence) do
            local character = player.Character
            if character and character:FindFirstChild("HumanoidRootPart") then
                character.HumanoidRootPart.CFrame = cframe
                task.wait(0.5)
            else
                break
            end
        end
    end

    -- Teleport ƒë·∫øn part c·ª• th·ªÉ
    local function teleportTo(part)
        if part and part:IsA("BasePart") then
            local character = player.Character
            if character and character:FindFirstChild("HumanoidRootPart") then
                character.HumanoidRootPart.CFrame = part.CFrame
            end
        end
    end

    -- Ki·ªÉm tra ƒëi·ªÅu ki·ªán ch·∫°y th·ª≠
    local function canRunTrial()
        local saveData = Save.Get()
        if not saveData or not saveData.TimeTrialStats then
            return false
        end
        local totalRuns = saveData.TimeTrialStats.TotalRuns or 0
        return totalRuns < 10
    end

    -- C√°c v·ªã tr√≠ teleport trong map
    local teleportSequencePoints = {
        CFrame.new(-18079, 20, -484),
        CFrame.new(-18359, 20, -560),
        CFrame.new(-18306, 20, -695),
        CFrame.new(-18222, 20, -604),
        CFrame.new(-18221, 20, -458),
        CFrame.new(-18110, 20, -658),
    }

    -- Ki·ªÉm tra nh√¢n v·∫≠t ƒë√£ load
    local character = player.Character
    if not (character and character:FindFirstChild("HumanoidRootPart")) then
        warn("‚ùå Kh√¥ng t√¨m th·∫•y nh√¢n v·∫≠t, d·ª´ng script")
        return
    end

    -- B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p ch√≠nh
    while true do

        if not canRunTrial() then
            warn("üö´ ƒê√£ ƒë·ªß 10 l·∫ßn, d·ª´ng script")
            break
        end

        stopSignal = false -- reset c·ªù

        -- Teleport v√†o Time Trial
        teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Enter)
        task.wait(5)

        -- L·∫∑p d·ªãch chuy·ªÉn li√™n t·ª•c cho t·ªõi khi c√≥ t√≠n hi·ªáu k·∫øt th√∫c
        while not stopSignal do
            teleportSequence(player, teleportSequencePoints)
        end

        -- Sau khi xong ‚Üí tho√°t ra ngo√†i
        teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Leave)
        task.wait(15)
    end

end)
