if _G.VAR_TIME_TRIAL then
	warn("Script Ä‘Ã£ Ä‘Æ°á»£c cháº¡y trÆ°á»›c Ä‘Ã³!")
	return
end

_G.VAR_TIME_TRIAL = true

-- Khá»Ÿi táº¡o GUI Time Trial
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local Save = require(game.ReplicatedStorage.Library.Client.Save)

-- XÃ³a GUI cÅ© náº¿u Ä‘Ã£ tá»“n táº¡i
local playerGui = player:WaitForChild("PlayerGui")
local oldGui = playerGui:FindFirstChild("TimeTrialGui")
if oldGui then oldGui:Destroy() end

-- HÃ m láº¥y lÆ°á»£t cÃ²n láº¡i
local function getRunsLeft()
	local saveData = Save.Get()
	if saveData and saveData.TimeTrialStats then
		local usedRuns = saveData.TimeTrialStats.DailyRuns or 0
		return math.max(0, 10 - usedRuns)
	end
	return 0
end

-- HÃ m láº¥y tá»•ng lÆ°á»£t Ä‘Ã£ dÃ¹ng
local function getRunsUsed()
	local saveData = Save.Get()
	return saveData and saveData.TimeTrialStats and saveData.TimeTrialStats.DailyRuns or 0
end

-- HÃ m láº¥y sá»‘ Ä‘iá»ƒm Time Trial
local function getTimeTrialPoints()
	local saveData = Save.Get()
	if saveData and saveData.TimeTrialStats and type(saveData.TimeTrialStats.Points) == "number" then
		return saveData.TimeTrialStats.Points
	end
	return 0
end

-- Táº¡o GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "TimeTrialGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local function createLabel(name, position, anchor, bgColor)
	local label = Instance.new("TextLabel")
	label.Name = name
	label.AnchorPoint = anchor or Vector2.new(0, 0)
	label.Position = position
	label.Size = UDim2.new(0, 0, 0, 38)
	label.BackgroundColor3 = bgColor
	label.TextColor3 = Color3.fromRGB(255, 255, 255)
	label.Font = Enum.Font.GothamBold
	label.TextSize = 32
	label.Text = "..."
	label.BackgroundTransparency = 0
	label.BorderSizePixel = 0
	label.TextXAlignment = Enum.TextXAlignment.Center
	label.Parent = screenGui
	return label
end

-- ğŸ§­ Táº¡o label: Points (trÃ¡i trÃªn), TimeTrial (giá»¯a trÃªn)
local pointsLabel = createLabel("PointsLabel", UDim2.new(0, 0, 0, -55), Vector2.new(0, 0), Color3.fromRGB(0, 128, 255))
local timeTrialLabel = createLabel("TimeTrialLabel", UDim2.new(0.5, 25, 0, -55), Vector2.new(0.5, 0), Color3.fromRGB(128, 0, 128))

-- Cáº­p nháº­t kÃ­ch thÆ°á»›c theo text
local function updateLabelSize(label)
	label.Size = UDim2.new(0, label.TextBounds.X + 20, 0, 38)
end

-- Cáº­p nháº­t GUI má»—i 10 giÃ¢y
task.spawn(function()
	while true do
		local runsLeft = getRunsLeft()
		local points = getTimeTrialPoints()

		pointsLabel.Text = "Äiá»ƒm: " .. tostring(points)
		updateLabelSize(pointsLabel)

		timeTrialLabel.Text = "Time Trial: " .. tostring(runsLeft) .. " / 10"
		updateLabelSize(timeTrialLabel)

		task.wait(10)
	end
end)
-- Biáº¿n retry náº¿u bá»‹ stuck
local _stuckRetries = 0
local stuckMonitorThread = nil

local function stopMonitorStuck()
	if stuckMonitorThread then
		task.cancel(stuckMonitorThread)
		stuckMonitorThread = nil
	end
end

local function RunTimeTrialScript()
	task.spawn(function()
		if game.PlaceId ~= 140403681187145 then return end

		local ZoneCmds = require(game.ReplicatedStorage.Library.Client.ZoneCmds)
		local BreakablesFolder = workspace.__THINGS.Breakables
		local EnterTeleport = workspace.__THINGS.Instances.TimeTrial.Teleports.Enter
		local LeaveTeleport = workspace.__THINGS.Instances.TimeTrial.Teleports.Leave

		local function teleportTo(part)
			if part and part.CFrame then
				local character = player.Character or player.CharacterAdded:Wait()
				if character and character:FindFirstChild("HumanoidRootPart") then
					character.HumanoidRootPart.CFrame = part.CFrame + Vector3.new(0, 5, 0)
				end
			end
		end

		local function isValidBreakable(instance)
			return instance:IsA("Model") and tonumber(instance.Name) ~= nil
		end

		local function getCurrentBreakables()
			local list = {}
			for _, child in ipairs(BreakablesFolder:GetChildren()) do
				if isValidBreakable(child) then
					table.insert(list, child.Name)
				end
			end
			return list
		end

		local function waitUntilBreakableGone(name)
			while true do
				local breakable = BreakablesFolder:FindFirstChild(name)
				if not breakable then break end
				task.wait(0.1)
			end
		end

		local function teleportToBreakables()
			local noChangeCounter = 0
			local lastRun = getRunsUsed()

			while true do
				local breakableNames = getCurrentBreakables()

				if #breakableNames > 0 then
					for _, name in ipairs(breakableNames) do
						local breakable = BreakablesFolder:FindFirstChild(name)
						if breakable and breakable:IsA("Model") then
							local part = breakable:FindFirstChildWhichIsA("BasePart")
							if part then
								teleportTo(part)
								waitUntilBreakableGone(name)
							end
						end
					end
				else
					local changed = false
					for i = 1, 20 do
						task.wait(1)
						if #getCurrentBreakables() > 0 then
							changed = true
							break
						end
					end

					if not changed then
						local newRun = getRunsUsed()
						if newRun > lastRun then
							warn("âœ… ÄÃ£ tÄƒng lÆ°á»£t Time Trial â‡’ rá»i khá»i Time Trial ngay!")
							if LeaveTeleport then
								teleportTo(LeaveTeleport)
								task.wait(3)
							end
							break
						else
							if LeaveTeleport then
								teleportTo(LeaveTeleport)
								task.wait(5)
							end
							break
						end
					end
				end
				task.wait(0.5)
			end
		end

		local function retryAfterStuck()
			if _stuckRetries >= 3 then
				player:Kick("Äá»©ng yÃªn quÃ¡ 60s trong Time Trial (Ä‘Ã£ thá»­ láº¡i 3 láº§n)")
				return
			end

			_stuckRetries += 1
			warn("ğŸ” Retry sau khi Ä‘á»©ng yÃªn " .. tostring(_stuckRetries) .. " láº§n")

			if LeaveTeleport then
				teleportTo(LeaveTeleport)
				task.wait(3)
			end

			if EnterTeleport then
				teleportTo(EnterTeleport)
				task.wait(5)
			end

			teleportToBreakables()
		end

		local function startMonitorStuck()
			if stuckMonitorThread then task.cancel(stuckMonitorThread) end

			stuckMonitorThread = task.spawn(function()
				local stationarySeconds = 0
				local lastPosition = nil

				while true do
					local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
					if not hrp then task.wait(1) continue end

					local currentPosition = hrp.Position
					if lastPosition and (currentPosition - lastPosition).Magnitude < 0.5 then
						stationarySeconds += 1
						if stationarySeconds >= 60 then
							stopMonitorStuck()
							retryAfterStuck()
							break
						end
					else
						stationarySeconds = 0
						lastPosition = currentPosition
					end
					task.wait(1)
				end
			end)
		end
local savedPosition = nil
		local wasTeleportedOut = false

		local _, maxZoneData = ZoneCmds.GetMaxOwnedZone()
		local requiredZoneNumber = maxZoneData and maxZoneData.ZoneNumber or 0

		local function waitUntilReachZone(targetZone)
			while true do
				local _, currentZoneData = ZoneCmds.GetMaxOwnedZone()
				if currentZoneData and currentZoneData.ZoneNumber >= targetZone then
					print("âœ… ÄÃ£ Ä‘áº¡t Zone " .. targetZone .. ", báº¯t Ä‘áº§u cháº¡y Time Trial.")
					break
				end
				print("â³ ChÆ°a Ä‘áº¡t Zone " .. targetZone .. ", Ä‘ang Ä‘á»£i...")
				task.wait(5)
			end
		end

		waitUntilReachZone(requiredZoneNumber)

		-- Theo dÃµi 12 phÃºt khÃ´ng giáº£m lÆ°á»£t (chá»‰ sau khi cÃ³ Ä‘iá»ƒm Time Trial)
		task.spawn(function()
			while getTimeTrialPoints() <= 0 do
				print("ğŸ•“ ChÆ°a cÃ³ Ä‘iá»ƒm Time Trial, chá» Ä‘iá»ƒm...")
				task.wait(10)
			end

			local currentRuns = getRunsUsed()
			if currentRuns >= 10 then return end

			while currentRuns < 10 do
				local startRuns = currentRuns
				local totalTime = 0

				while totalTime < 686 do
					task.wait(10)
					totalTime += 10
					currentRuns = getRunsUsed()

					if currentRuns > startRuns then
						break
					elseif currentRuns >= 10 then
						return
					end
				end

				if currentRuns == startRuns then
					player:Kick("â° 12 phÃºt khÃ´ng giáº£m lÆ°á»£t Time Trial.")
					return
				end
			end
		end)

		while true do
			local currentRun = getRunsUsed()
			if currentRun >= 10 then break end

			warn("ğŸ” Báº¯t Ä‘áº§u lÆ°á»£t Time Trial #" .. tostring(currentRun + 1))

			local character = player.Character or player.CharacterAdded:Wait()
			local hrp = character:FindFirstChild("HumanoidRootPart")
			if hrp then
				savedPosition = hrp.CFrame
			end

			if EnterTeleport then
				teleportTo(EnterTeleport)
				task.wait(5)
			end

			wasTeleportedOut = false
			startMonitorStuck()
			teleportToBreakables()
			stopMonitorStuck()

			task.wait(3)

			local afterRun = getRunsUsed()

			if LeaveTeleport then
				teleportTo(LeaveTeleport)
				task.wait(3)
				wasTeleportedOut = true
			end

			warn("ğŸ‰ ÄÃ£ hoÃ n thÃ nh lÆ°á»£t, tá»•ng Ä‘Ã£ dÃ¹ng: " .. tostring(afterRun))

			if savedPosition and not wasTeleportedOut then
				local fakePart = Instance.new("Part")
				fakePart.Anchored = true
				fakePart.CFrame = savedPosition
				fakePart.Transparency = 1
				fakePart.CanCollide = false
				fakePart.Parent = workspace
				teleportTo(fakePart)
				task.delay(1, function() fakePart:Destroy() end)
			end

			task.wait(15)
		end

		warn("ğŸ‰ HoÃ n táº¥t 10 lÆ°á»£t Time Trial!")

		task.spawn(function()
			while true do
				task.wait(300)
				local checkRun = getRunsUsed()
				if checkRun < 10 then
					warn("ğŸ” ÄÃ£ reset lÆ°á»£t â†’ cháº¡y láº¡i script.")
					_G.VAR_TIME_TRIAL = nil
					RunTimeTrialScript()
					break
				else
					print("â³ ChÆ°a reset, Ä‘á»£i tiáº¿p...")
				end
			end
		end)
	end)
end

-- ğŸš€ Gá»i script chÃ­nh
RunTimeTrialScript()
